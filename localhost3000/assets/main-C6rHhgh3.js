(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(t){if(t.ep)return;t.ep=!0;const n=i(t);fetch(t.href,n)}})();var R=(o=>(o[o.Floor=0]="Floor",o[o.Wall=1]="Wall",o[o.Hazard=2]="Hazard",o[o.Water=3]="Water",o[o.Void=4]="Void",o[o.Door=5]="Door",o[o.Breakable=6]="Breakable",o))(R||{});const gt={rust_tides:{id:"rust_tides",name:"Rust Tides",hazardDensity:.15,waterFeatures:!0,breakableWalls:.1,weather:"wind",palette:{0:"#553",1:"#864",2:"#4a3",3:"#486",4:"#110",5:"#f80",6:"#743"}},glass_flood:{id:"glass_flood",name:"Glass Flood",hazardDensity:.05,waterFeatures:!0,breakableWalls:.2,weather:"rain",palette:{0:"#446",1:"#68a",2:"#48f",3:"#4af",4:"#112",5:"#aef",6:"#567"}},neon_decay:{id:"neon_decay",name:"Neon Decay",hazardDensity:.1,waterFeatures:!1,breakableWalls:.05,weather:"none",palette:{0:"#443",1:"#654",2:"#a4f",3:"#4a8",4:"#211",5:"#f4a",6:"#554"}}},Ei={seed:12345,mapWidth:50,mapHeight:30,roomCount:8,mobDensity:.3,playerStats:{},enableKiting:!0,kiteThreshold:.4,kiteDistance:3},re=100,Ai=6e3,Si=8,Ci=50,Ti=15,ke=23283064365386963e-26;class mt{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*ke,e=e*69069+1>>>0,this._s1=e*ke,e=e*69069+1>>>0,this._s2=e*ke,this._c=1,this}getUniform(){let e=2091639*this._s0+this._c*ke;return this._s0=this._s1,this._s1=this._s2,this._c=e|0,this._s2=e-this._c,this._s2}getUniformInt(e,i){let s=Math.max(e,i),t=Math.min(e,i);return Math.floor(this.getUniform()*(s-t+1))+t}getNormal(e=0,i=1){let s,t,n;do s=2*this.getUniform()-1,t=2*this.getUniform()-1,n=s*s+t*t;while(n>1||n==0);let r=s*Math.sqrt(-2*Math.log(n)/n);return e+r*i}getPercentage(){return 1+Math.floor(this.getUniform()*100)}getItem(e){return e.length?e[Math.floor(this.getUniform()*e.length)]:null}shuffle(e){let i=[],s=e.slice();for(;s.length;){let t=s.indexOf(this.getItem(s));i.push(s.splice(t,1)[0])}return i}getWeightedValue(e){let i=0;for(let r in e)i+=e[r];let s=this.getUniform()*i,t,n=0;for(t in e)if(n+=e[t],s<n)return t;return t}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(e){return this._s0=e[0],this._s1=e[1],this._s2=e[2],this._c=e[3],this}clone(){return new mt().setState(this.getState())}}const X=new mt().setSeed(Date.now());class Bi{getContainer(){return null}setOptions(e){this._options=e}}class Di extends Bi{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(e){requestAnimationFrame(e)}getContainer(){return this._ctx.canvas}setOptions(e){super.setOptions(e);const s=`${e.fontStyle?`${e.fontStyle} `:""} ${e.fontSize}px ${e.fontFamily}`;this._ctx.font=s,this._updateSize(),this._ctx.font=s,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){const e=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=e}eventToPosition(e,i){let s=this._ctx.canvas,t=s.getBoundingClientRect();return e-=t.left,i-=t.top,e*=s.width/t.width,i*=s.height/t.height,e<0||i<0||e>=s.width||i>=s.height?[-1,-1]:this._normalizedEventToPosition(e,i)}}class yt extends Di{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(e){super.setOptions(e),this._canvasCache={}}draw(e,i){yt.cache?this._drawWithCache(e):this._drawNoCache(e,i)}_drawWithCache(e){let[i,s,t,n,r]=e,a=""+t+n+r,l;if(a in this._canvasCache)l=this._canvasCache[a];else{let c=this._options.border;l=document.createElement("canvas");let d=l.getContext("2d");if(l.width=this._spacingX,l.height=this._spacingY,d.fillStyle=r,d.fillRect(c,c,l.width-c,l.height-c),t){d.fillStyle=n,d.font=this._ctx.font,d.textAlign="center",d.textBaseline="middle";let h=[].concat(t);for(let p=0;p<h.length;p++)d.fillText(h[p],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=l}this._ctx.drawImage(l,i*this._spacingX,s*this._spacingY)}_drawNoCache(e,i){let[s,t,n,r,a]=e;if(i){let c=this._options.border;this._ctx.fillStyle=a,this._ctx.fillRect(s*this._spacingX+c,t*this._spacingY+c,this._spacingX-c,this._spacingY-c)}if(!n)return;this._ctx.fillStyle=r;let l=[].concat(n);for(let c=0;c<l.length;c++)this._ctx.fillText(l[c],(s+.5)*this._spacingX,Math.ceil((t+.5)*this._spacingY))}computeSize(e,i){let s=Math.floor(e/this._spacingX),t=Math.floor(i/this._spacingY);return[s,t]}computeFontSize(e,i){let s=Math.floor(e/this._options.width),t=Math.floor(i/this._options.height),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let r=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let l=r/100*t/s;return l>1&&(t=Math.floor(t/l)),Math.floor(t/this._options.spacing)}_normalizedEventToPosition(e,i){return[Math.floor(e/this._spacingX),Math.floor(i/this._spacingY)]}_updateSize(){const e=this._options,i=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(e.spacing*i),this._spacingY=Math.ceil(e.spacing*e.fontSize),e.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=e.width*this._spacingX,this._ctx.canvas.height=e.height*this._spacingY}}yt.cache=!1;let Pi=80,Ri=25;const oe={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]};let Fi=class{constructor(e,i={}){this._lightPasses=e,this._options=Object.assign({topology:8},i)}_getCircle(e,i,s){let t=[],n,r,a;switch(this._options.topology){case 4:r=1,a=[0,1],n=[oe[8][7],oe[8][1],oe[8][3],oe[8][5]];break;case 6:n=oe[6],r=1,a=[-1,1];break;case 8:n=oe[4],r=2,a=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let l=e+a[0]*s,c=i+a[1]*s;for(let d=0;d<n.length;d++)for(let h=0;h<s*r;h++)t.push([l,c]),l+=n[d][0],c+=n[d][1];return t}};class Ni extends Fi{compute(e,i,s,t){if(t(e,i,0,1),!this._lightPasses(e,i))return;let n=[],r,a,l,c,d,h;for(let p=1;p<=s;p++){let u=this._getCircle(e,i,p),m=u.length;for(let b=0;b<m;b++)if(r=u[b][0],a=u[b][1],c=[b?2*b-1:2*m-1,2*m],d=[2*b+1,2*m],l=!this._lightPasses(r,a),h=this._checkVisibility(c,d,l,n),h&&t(r,a,p,h),n.length==2&&n[0][0]==0&&n[1][0]==n[1][1])return}}_checkVisibility(e,i,s,t){if(e[0]>i[0]){let u=this._checkVisibility(e,[e[1],e[1]],s,t),m=this._checkVisibility([0,1],i,s,t);return(u+m)/2}let n=0,r=!1;for(;n<t.length;){let u=t[n],m=u[0]*e[1]-e[0]*u[1];if(m>=0){m==0&&!(n%2)&&(r=!0);break}n++}let a=t.length,l=!1;for(;a--;){let u=t[a],m=i[0]*u[1]-u[0]*i[1];if(m>=0){m==0&&a%2&&(l=!0);break}}let c=!0;if((n==a&&(r||l)||r&&l&&n+1==a&&a%2||n>a&&n%2)&&(c=!1),!c)return 0;let d,h=a-n+1;if(h%2)if(n%2){let u=t[n];d=(i[0]*u[1]-u[0]*i[1])/(u[1]*i[1]),s&&t.splice(n,h,i)}else{let u=t[a];d=(u[0]*e[1]-e[0]*u[1])/(e[1]*u[1]),s&&t.splice(n,h,e)}else if(n%2){let u=t[n],m=t[a];d=(m[0]*u[1]-u[0]*m[1])/(u[1]*m[1]),s&&t.splice(n,h)}else return s&&t.splice(n,h,e,i),1;let p=(i[0]*e[1]-e[0]*i[1])/(e[1]*i[1]);return d/p}}const Wi={PreciseShadowcasting:Ni};let $i=class{constructor(e=Pi,i=Ri){this._width=e,this._height=i}_fillMap(e){let i=[];for(let s=0;s<this._width;s++){i.push([]);for(let t=0;t<this._height;t++)i[s].push(e)}return i}};class ji extends $i{constructor(e,i){super(e,i),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class ii{}class ft extends ii{constructor(e,i,s,t,n,r){super(),this._x1=e,this._y1=i,this._x2=s,this._y2=t,this._doors={},n!==void 0&&r!==void 0&&this.addDoor(n,r)}static createRandomAt(e,i,s,t,n){let r=n.roomWidth[0],a=n.roomWidth[1],l=X.getUniformInt(r,a);r=n.roomHeight[0],a=n.roomHeight[1];let c=X.getUniformInt(r,a);if(s==1){let d=i-Math.floor(X.getUniform()*c);return new this(e+1,d,e+l,d+c-1,e,i)}if(s==-1){let d=i-Math.floor(X.getUniform()*c);return new this(e-l,d,e-1,d+c-1,e,i)}if(t==1){let d=e-Math.floor(X.getUniform()*l);return new this(d,i+1,d+l-1,i+c,e,i)}if(t==-1){let d=e-Math.floor(X.getUniform()*l);return new this(d,i-c,d+l-1,i-1,e,i)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(e,i,s){let t=s.roomWidth[0],n=s.roomWidth[1],r=X.getUniformInt(t,n);t=s.roomHeight[0],n=s.roomHeight[1];let a=X.getUniformInt(t,n),l=e-Math.floor(X.getUniform()*r),c=i-Math.floor(X.getUniform()*a),d=l+r-1,h=c+a-1;return new this(l,c,d,h)}static createRandom(e,i,s){let t=s.roomWidth[0],n=s.roomWidth[1],r=X.getUniformInt(t,n);t=s.roomHeight[0],n=s.roomHeight[1];let a=X.getUniformInt(t,n),l=e-r-1,c=i-a-1,d=1+Math.floor(X.getUniform()*l),h=1+Math.floor(X.getUniform()*c),p=d+r-1,u=h+a-1;return new this(d,h,p,u)}addDoor(e,i){return this._doors[e+","+i]=1,this}getDoors(e){for(let i in this._doors){let s=i.split(",");e(parseInt(s[0]),parseInt(s[1]))}return this}clearDoors(){return this._doors={},this}addDoors(e){let i=this._x1-1,s=this._x2+1,t=this._y1-1,n=this._y2+1;for(let r=i;r<=s;r++)for(let a=t;a<=n;a++)r!=i&&r!=s&&a!=t&&a!=n||e(r,a)||this.addDoor(r,a);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(e,i){let s=this._x1-1,t=this._x2+1,n=this._y1-1,r=this._y2+1;for(let a=s;a<=t;a++)for(let l=n;l<=r;l++)if(a==s||a==t||l==n||l==r){if(!e(a,l))return!1}else if(!i(a,l))return!1;return!0}create(e){let i=this._x1-1,s=this._x2+1,t=this._y1-1,n=this._y2+1,r=0;for(let a=i;a<=s;a++)for(let l=t;l<=n;l++)a+","+l in this._doors?r=2:a==i||a==s||l==t||l==n?r=1:r=0,e(a,l,r)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class si extends ii{constructor(e,i,s,t){super(),this._startX=e,this._startY=i,this._endX=s,this._endY=t,this._endsWithAWall=!0}static createRandomAt(e,i,s,t,n){let r=n.corridorLength[0],a=n.corridorLength[1],l=X.getUniformInt(r,a);return new this(e,i,e+s*l,i+t*l)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(e,i){let s=this._startX,t=this._startY,n=this._endX-s,r=this._endY-t,a=1+Math.max(Math.abs(n),Math.abs(r));n&&(n=n/Math.abs(n)),r&&(r=r/Math.abs(r));let l=r,c=-n,d=!0;for(let u=0;u<a;u++){let m=s+u*n,b=t+u*r;if(i(m,b)||(d=!1),e(m+l,b+c)||(d=!1),e(m-l,b-c)||(d=!1),!d){a=u,this._endX=m-n,this._endY=b-r;break}}if(a==0||a==1&&e(this._endX+n,this._endY+r))return!1;let h=!e(this._endX+n+l,this._endY+r+c),p=!e(this._endX+n-l,this._endY+r-c);return this._endsWithAWall=e(this._endX+n,this._endY+r),!((h||p)&&this._endsWithAWall)}create(e){let i=this._startX,s=this._startY,t=this._endX-i,n=this._endY-s,r=1+Math.max(Math.abs(t),Math.abs(n));t&&(t=t/Math.abs(t)),n&&(n=n/Math.abs(n));for(let a=0;a<r;a++){let l=i+a*t,c=s+a*n;e(l,c,0)}return!0}createPriorityWalls(e){if(!this._endsWithAWall)return;let i=this._startX,s=this._startY,t=this._endX-i,n=this._endY-s;t&&(t=t/Math.abs(t)),n&&(n=n/Math.abs(n));let r=n,a=-t;e(this._endX+t,this._endY+n),e(this._endX+r,this._endY+a),e(this._endX-r,this._endY-a)}}const Li={room:ft,corridor:si};class Oi extends ji{constructor(e,i,s={}){super(e,i),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},s),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(e){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let i=(this._width-2)*(this._height-2);this._firstRoom();let s=Date.now(),t;do{if(t=0,Date.now()-s>this._options.timeLimit)break;let r=this._findWall();if(!r)break;let a=r.split(","),l=parseInt(a[0]),c=parseInt(a[1]),d=this._getDiggingDirection(l,c);if(!d)continue;let h=0;do if(h++,this._tryFeature(l,c,d[0],d[1])){this._removeSurroundingWalls(l,c),this._removeSurroundingWalls(l-d[0],c-d[1]);break}while(h<this._featureAttempts);for(let p in this._walls)this._walls[p]>1&&t++}while(this._dug/i<this._options.dugPercentage||t);if(this._addDoors(),e)for(let n=0;n<this._width;n++)for(let r=0;r<this._height;r++)e(n,r,this._map[n][r]);return this._walls={},this._map=[],this}_digCallback(e,i,s){s==0||s==2?(this._map[e][i]=0,this._dug++):this._walls[e+","+i]=1}_isWallCallback(e,i){return e<0||i<0||e>=this._width||i>=this._height?!1:this._map[e][i]==1}_canBeDugCallback(e,i){return e<1||i<1||e+1>=this._width||i+1>=this._height?!1:this._map[e][i]==1}_priorityWallCallback(e,i){this._walls[e+","+i]=2}_firstRoom(){let e=Math.floor(this._width/2),i=Math.floor(this._height/2),s=ft.createRandomCenter(e,i,this._options);this._rooms.push(s),s.create(this._digCallback)}_findWall(){let e=[],i=[];for(let n in this._walls)this._walls[n]==2?i.push(n):e.push(n);let s=i.length?i:e;if(!s.length)return null;let t=X.getItem(s.sort());return delete this._walls[t],t}_tryFeature(e,i,s,t){let n=X.getWeightedValue(this._features),a=Li[n].createRandomAt(e,i,s,t,this._options);return a.isValid(this._isWallCallback,this._canBeDugCallback)?(a.create(this._digCallback),a instanceof ft&&this._rooms.push(a),a instanceof si&&(a.createPriorityWalls(this._priorityWallCallback),this._corridors.push(a)),!0):!1}_removeSurroundingWalls(e,i){let s=oe[4];for(let t=0;t<s.length;t++){let n=s[t],r=e+n[0],a=i+n[1];delete this._walls[r+","+a],r=e+2*n[0],a=i+2*n[1],delete this._walls[r+","+a]}}_getDiggingDirection(e,i){if(e<=0||i<=0||e>=this._width-1||i>=this._height-1)return null;let s=null,t=oe[4];for(let n=0;n<t.length;n++){let r=t[n],a=e+r[0],l=i+r[1];if(!this._map[a][l]){if(s)return null;s=r}}return s?[-s[0],-s[1]]:null}_addDoors(){let e=this._map;function i(s,t){return e[s][t]==1}for(let s=0;s<this._rooms.length;s++){let t=this._rooms[s];t.clearDoors(),t.addDoors(i)}}}const qi={Digger:Oi},Hi={maxIntegrity:800,maxShield:150,moveSpeed:5.5,attackRange:8,attackDamage:50,attackCooldown:6,armor:20,visionRadius:12,aggroRadius:0,leashRadius:0,engagementSlots:6,critChance:.2,critMultiplier:2,damageVariance:.15},ni={grunt:{id:"grunt",name:"Rust Grunt",stats:{maxIntegrity:60,maxShield:0,moveSpeed:2.5,attackRange:1.5,attackDamage:15,attackCooldown:15,armor:5,visionRadius:8,aggroRadius:6,leashRadius:20,engagementSlots:1,critChance:.05,critMultiplier:1.5,damageVariance:.1},skills:["melee_strike"]},shooter:{id:"shooter",name:"Bolt Caster",stats:{maxIntegrity:40,maxShield:15,moveSpeed:2,attackRange:7,attackDamage:20,attackCooldown:18,armor:3,visionRadius:10,aggroRadius:8,leashRadius:15,engagementSlots:1,critChance:.1,critMultiplier:1.6,damageVariance:.1},skills:["ranged_bolt"]},brute:{id:"brute",name:"Ramming Brute",stats:{maxIntegrity:120,maxShield:0,moveSpeed:3.5,attackRange:2,attackDamage:30,attackCooldown:22,armor:15,visionRadius:6,aggroRadius:5,leashRadius:25,engagementSlots:2,critChance:.08,critMultiplier:2,damageVariance:.15},skills:["heavy_slam"]},elite_sentinel:{id:"elite_sentinel",name:"Elite Sentinel",stats:{maxIntegrity:200,maxShield:80,moveSpeed:3,attackRange:5,attackDamage:40,attackCooldown:16,armor:20,visionRadius:12,aggroRadius:10,leashRadius:30,engagementSlots:4,critChance:.12,critMultiplier:1.7,damageVariance:.1},skills:["beam_sweep"]},boss_warden:{id:"boss_warden",name:"Warden of the Fracture",stats:{maxIntegrity:300,maxShield:50,moveSpeed:2,attackRange:5,attackDamage:40,attackCooldown:22,armor:15,visionRadius:15,aggroRadius:15,leashRadius:50,engagementSlots:8,critChance:.1,critMultiplier:1.5,damageVariance:.1},skills:["devastate"]}},Vi={player_shot:{id:"player_shot",name:"Railshot",damage:50,range:8,cooldown:6,damageType:"kinetic"},player_aoe:{id:"player_aoe",name:"Explosive Round",damage:25,range:6,cooldown:25,damageType:"thermal",aoeRadius:2},melee_strike:{id:"melee_strike",name:"Melee Strike",damage:15,range:1.5,cooldown:15,damageType:"kinetic"},ranged_bolt:{id:"ranged_bolt",name:"Bolt",damage:20,range:7,cooldown:18,damageType:"em",isProjectile:!0,projectileSpeed:12},heavy_slam:{id:"heavy_slam",name:"Heavy Slam",damage:30,range:2,cooldown:22,damageType:"kinetic",statusEffect:{type:"slow",duration:20,value:.4}},beam_sweep:{id:"beam_sweep",name:"Beam Sweep",damage:40,range:5,cooldown:16,damageType:"thermal"},devastate:{id:"devastate",name:"Devastate",damage:55,range:6,cooldown:20,damageType:"kinetic"},boss_dot:{id:"boss_dot",name:"Corrosive Spray",damage:10,range:6,cooldown:35,damageType:"corrosive",statusEffect:{type:"dot",duration:50,value:5}}},Ui=[{id:"small_grunt",mobs:[{templateId:"grunt",count:2}]},{id:"grunt_squad",mobs:[{templateId:"grunt",count:3}]},{id:"mixed_patrol",mobs:[{templateId:"grunt",count:2},{templateId:"shooter",count:1}]},{id:"shooter_nest",mobs:[{templateId:"shooter",count:2}]},{id:"brute_pair",mobs:[{templateId:"brute",count:1}]},{id:"elite_guard",mobs:[{templateId:"elite_sentinel",count:1}],isElite:!0},{id:"boss_encounter",mobs:[{templateId:"boss_warden",count:1}],isBoss:!0}];class oi{seed;constructor(e){this.seed=e}next(){let e=this.seed+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}nextInt(e,i){return Math.floor(this.next()*(i-e+1))+e}pick(e){return e[this.nextInt(0,e.length-1)]}shuffle(e){for(let i=e.length-1;i>0;i--){const s=this.nextInt(0,i),t=e[i];e[i]=e[s],e[s]=t}return e}}const Ne={warrior:{id:"warrior",name:"Vanguard Frame",description:"Heavy melee combatant with high armor and cleave attacks.",baseStats:{maxIntegrity:1e3,maxShield:100,moveSpeed:4,attackRange:1.5,attackDamage:80,attackCooldown:10,armor:30,visionRadius:8,critChance:.15,critMultiplier:1.8,damageVariance:.1},skills:["warrior_slash","warrior_cleave","warrior_shield_bash"],attackType:"melee",hasAoE:!0},ranger:{id:"ranger",name:"Recon Frame",description:"Fast ranged combatant with high vision and precision strikes.",baseStats:{maxIntegrity:600,maxShield:80,moveSpeed:5.5,attackRange:8,attackDamage:120,attackCooldown:8,armor:10,visionRadius:12,critChance:.25,critMultiplier:2.2,damageVariance:.1},skills:["ranger_shot","ranger_piercing","ranger_multishot"],attackType:"ranged",hasAoE:!1},mage:{id:"mage",name:"Artillery Frame",description:"Powerful AoE caster with devastating area attacks.",baseStats:{maxIntegrity:500,maxShield:150,moveSpeed:4,attackRange:6,attackDamage:100,attackCooldown:12,armor:5,visionRadius:10,critChance:.2,critMultiplier:2,damageVariance:.15},skills:["mage_bolt","mage_fireball","mage_blizzard"],attackType:"magic",hasAoE:!0}},ai={warrior_slash:{id:"warrior_slash",name:"Slash",damage:80,range:1.5,cooldown:10,damageType:"kinetic"},warrior_cleave:{id:"warrior_cleave",name:"Cleave",damage:60,range:2,cooldown:18,damageType:"kinetic",aoeRadius:2.5},warrior_shield_bash:{id:"warrior_shield_bash",name:"Shield Bash",damage:40,range:1.5,cooldown:25,damageType:"kinetic",statusEffect:{type:"stun",duration:15,value:1}},ranger_shot:{id:"ranger_shot",name:"Precision Shot",damage:120,range:8,cooldown:8,damageType:"kinetic",isProjectile:!0,projectileSpeed:20},ranger_piercing:{id:"ranger_piercing",name:"Piercing Arrow",damage:180,range:10,cooldown:20,damageType:"kinetic",isProjectile:!0,projectileSpeed:25},ranger_multishot:{id:"ranger_multishot",name:"Multishot",damage:60,range:7,cooldown:15,damageType:"kinetic",isProjectile:!0,projectileSpeed:18},mage_bolt:{id:"mage_bolt",name:"Arcane Bolt",damage:100,range:6,cooldown:12,damageType:"em",isProjectile:!0,projectileSpeed:15},mage_fireball:{id:"mage_fireball",name:"Fireball",damage:80,range:7,cooldown:22,damageType:"thermal",isProjectile:!0,projectileSpeed:12,aoeRadius:3},mage_blizzard:{id:"mage_blizzard",name:"Blizzard",damage:40,range:5,cooldown:35,damageType:"thermal",aoeRadius:4,statusEffect:{type:"slow",duration:30,value:.5}}},he={balanced:{objectives:{clearAllMobs:!1,killBoss:!0,findAllTreasure:!1},engagement:{maxNormalMobs:5,maxEliteMobs:2,maxBosses:1,preferredPullSize:3},combat:{targetPriority:"closest",kiteEnabled:!0,kiteThreshold:.4,retreatThreshold:.1,useAoE:!0,aoeThreshold:2},navigation:{preferUnexplored:.5,avoidDanger:.5,exitPriority:.5}},speedrunner:{objectives:{clearAllMobs:!1,killBoss:!1,findAllTreasure:!1},engagement:{maxNormalMobs:2,maxEliteMobs:1,maxBosses:0,preferredPullSize:0},combat:{targetPriority:"closest",kiteEnabled:!0,kiteThreshold:.6,retreatThreshold:.3,useAoE:!1,aoeThreshold:99},navigation:{preferUnexplored:0,avoidDanger:.9,exitPriority:1}},completionist:{objectives:{clearAllMobs:!0,killBoss:!0,findAllTreasure:!0},engagement:{maxNormalMobs:10,maxEliteMobs:5,maxBosses:2,preferredPullSize:5},combat:{targetPriority:"weakest",kiteEnabled:!0,kiteThreshold:.3,retreatThreshold:.05,useAoE:!0,aoeThreshold:2},navigation:{preferUnexplored:1,avoidDanger:.2,exitPriority:0}},treasure_hunter:{objectives:{clearAllMobs:!1,killBoss:!1,findAllTreasure:!0},engagement:{maxNormalMobs:3,maxEliteMobs:1,maxBosses:0,preferredPullSize:2},combat:{targetPriority:"closest",kiteEnabled:!0,kiteThreshold:.5,retreatThreshold:.2,useAoE:!0,aoeThreshold:3},navigation:{preferUnexplored:.9,avoidDanger:.6,exitPriority:.3}},boss_farmer:{objectives:{clearAllMobs:!1,killBoss:!0,findAllTreasure:!1},engagement:{maxNormalMobs:5,maxEliteMobs:3,maxBosses:99,preferredPullSize:3},combat:{targetPriority:"boss_first",kiteEnabled:!0,kiteThreshold:.4,retreatThreshold:.15,useAoE:!0,aoeThreshold:2},navigation:{preferUnexplored:.7,avoidDanger:.3,exitPriority:.2}},elite_farmer:{objectives:{clearAllMobs:!1,killBoss:!1,findAllTreasure:!1},engagement:{maxNormalMobs:4,maxEliteMobs:99,maxBosses:1,preferredPullSize:3},combat:{targetPriority:"elite_first",kiteEnabled:!0,kiteThreshold:.4,retreatThreshold:.1,useAoE:!0,aoeThreshold:2},navigation:{preferUnexplored:.8,avoidDanger:.1,exitPriority:.4}}},Yi=he.balanced,ri="ranger";function Xi(){return{...Vi,...ai}}const zi={warrior:[{skillId:"warrior_shield_bash",enabled:!0,priority:90,onlyVsBoss:!1,onlyVsElite:!0},{skillId:"warrior_cleave",enabled:!0,priority:70,minEnemiesNearby:2},{skillId:"warrior_slash",enabled:!0,priority:50}],ranger:[{skillId:"ranger_piercing",enabled:!0,priority:90,onlyVsBoss:!0},{skillId:"ranger_piercing",enabled:!0,priority:85,onlyVsElite:!0},{skillId:"ranger_multishot",enabled:!0,priority:70,minEnemiesNearby:3},{skillId:"ranger_shot",enabled:!0,priority:50}],mage:[{skillId:"mage_blizzard",enabled:!0,priority:90,minEnemiesNearby:4},{skillId:"mage_fireball",enabled:!0,priority:70,minEnemiesNearby:2},{skillId:"mage_bolt",enabled:!0,priority:50}]};function li(o){return(zi[o]??[]).map(i=>({...i}))}function ci(o){const{seed:e,width:i,height:s}=o,t=o.roomCount??8,n=o.mobDensity??.3,r=o.biome??"rust_tides",a=gt[r],l=new oi(e),c=[];for(let I=0;I<s;I++){c[I]=[];for(let C=0;C<i;C++)c[I][C]=de(R.Wall)}const d=new qi.Digger(i,s,{roomWidth:[8,16],roomHeight:[6,12],corridorLength:[2,5],dugPercentage:.75});d.create((I,C,W)=>{W===0&&c[C]?.[I]&&(c[C][I]=de(R.Floor))});const h=d.getRooms(),u=h.slice(0,Math.min(t,h.length)).map((I,C)=>({id:`room_${C}`,x:I.getLeft(),y:I.getTop(),width:I.getRight()-I.getLeft()+1,height:I.getBottom()-I.getTop()+1,centerX:Math.floor((I.getLeft()+I.getRight())/2),centerY:Math.floor((I.getTop()+I.getBottom())/2),type:"normal",connections:[]}));u[0]&&(u[0].type="entrance");const m=u[0]?{x:u[0].centerX,y:u[0].centerY}:{x:Math.floor(i/2),y:Math.floor(s/2)},b=u.slice(Math.max(1,Math.floor(u.length/2))),f=b.length>0?b[Math.floor(l.next()*b.length)]:u[u.length-1];f&&(f.type="exit");const y=f?{x:f.centerX,y:f.centerY}:{x:i-2,y:s-2},g=[];for(let I=1;I<u.length;I++){const C=u[I];if(!C)continue;const W=I/u.length,J=I<3?.9:n+W*.2;if(l.next()<J){const $=l.pick(Ui.filter(K=>!K.isBoss));g.push({id:`spawn_${C.id}`,position:{x:C.centerX,y:C.centerY},mobTemplateId:$.mobs[0].templateId,mobCount:$.mobs.reduce((K,B)=>K+B.count,0),triggerRadius:8,state:"dormant",spawnedEntityIds:[],isElite:$.isElite??!1,isBoss:$.isBoss??!1})}}const v=u.filter((I,C)=>C>0&&I.id!==f?.id);if(v.length>0){const I=v[Math.floor(l.next()*v.length)];I&&g.push({id:"spawn_boss",position:{x:I.centerX,y:I.centerY},mobTemplateId:"boss_warden",mobCount:1,triggerRadius:10,state:"dormant",spawnedEntityIds:[],isBoss:!0})}const k=new Set,x=[m];for(k.add(`${Math.floor(m.x)},${Math.floor(m.y)}`);x.length>0;){const I=x.shift(),C=Math.floor(I.x),W=Math.floor(I.y);for(let J=-1;J<=1;J++)for(let $=-1;$<=1;$++){if($===0&&J===0)continue;const K=C+$,B=W+J,D=`${K},${B}`;!k.has(D)&&K>=0&&K<i&&B>=0&&B<s&&c[B]?.[K]?.passable&&(k.add(D),x.push({x:K,y:B}))}}const M=`${Math.floor(y.x)},${Math.floor(y.y)}`,A=k.has(M);if(!A&&e%1e4<5e3)return ci({...o,seed:e+1e3});const T=g.filter(I=>{const C=`${Math.floor(I.position.x)},${Math.floor(I.position.y)}`;return k.has(C)});if(T.length===0&&u.length>1)for(let I=1;I<u.length;I++){const C=u[I];if(!C)continue;const W=`${C.centerX},${C.centerY}`;if(k.has(W)){T.push({id:"spawn_fallback",position:{x:C.centerX,y:C.centerY},mobTemplateId:"grunt",mobCount:2,triggerRadius:8,state:"dormant",spawnedEntityIds:[]});break}}const _=[],E=["chest","chest","artifact","cache"],w=2+Math.floor(l.next()*4),F=[...u.filter((I,C)=>{if(C===0)return!1;const W=`${I.centerX},${I.centerY}`;return k.has(W)})];l.shuffle(F);for(let I=0;I<Math.min(w,F.length);I++){const C=F[I];if(!C)continue;const W=(l.next()-.5)*3,J=(l.next()-.5)*3,$=E[Math.floor(l.next()*E.length)]??"chest",K=$==="artifact"?100:$==="cache"?50:25,B=K+Math.floor(l.next()*K);_.push({id:`treasure_${I}`,position:{x:Math.floor(C.centerX+W),y:Math.floor(C.centerY+J)},type:$,collected:!1,value:B})}return Ji(c,u,a,l),{width:i,height:s,tiles:c,rooms:u,playerStart:m,exitPoint:A?y:m,spawnPoints:T,treasures:_,biome:r}}function Ji(o,e,i,s){const t=o.length,n=o[0]?.length??0;for(let r=0;r<t;r++)for(let a=0;a<n;a++){const l=o[r]?.[a];if(!l||l.type!==R.Floor)continue;!e.some(d=>a>=d.x&&a<d.x+d.width&&r>=d.y&&r<d.y+d.height)&&s.next()<i.hazardDensity&&(o[r][a]=de(R.Hazard))}if(i.waterFeatures)for(let r=1;r<t-1;r++)for(let a=0;a<3;a++){o[r]?.[a]?.type===R.Floor&&s.next()<.4&&(o[r][a]=de(R.Water));const l=n-1-a;o[r]?.[l]?.type===R.Floor&&s.next()<.4&&(o[r][l]=de(R.Water))}for(let r=1;r<t-1;r++)for(let a=1;a<n-1;a++){const l=o[r]?.[a];if(!l||l.type!==R.Wall)continue;(o[r-1]?.[a]?.type===R.Floor||o[r+1]?.[a]?.type===R.Floor||o[r]?.[a-1]?.type===R.Floor||o[r]?.[a+1]?.type===R.Floor)&&s.next()<i.breakableWalls&&(o[r][a]=de(R.Breakable))}}function de(o){return{type:o,passable:o===R.Floor||o===R.Hazard||o===R.Door,movementCost:o===R.Water?2:o===R.Hazard?1.5:1,blocksVision:o===R.Wall||o===R.Door,variant:0}}function Ki(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var Ee={exports:{}},Gi=Ee.exports,Et;function Qi(){return Et||(Et=1,(function(o){(function(){var e,i,s,t,n,r,a,l,c,d,h,p,u,m,b;s=Math.floor,d=Math.min,i=function(f,y){return f<y?-1:f>y?1:0},c=function(f,y,g,v,k){var x;if(g==null&&(g=0),k==null&&(k=i),g<0)throw new Error("lo must be non-negative");for(v==null&&(v=f.length);g<v;)x=s((g+v)/2),k(y,f[x])<0?v=x:g=x+1;return[].splice.apply(f,[g,g-g].concat(y)),y},r=function(f,y,g){return g==null&&(g=i),f.push(y),m(f,0,f.length-1,g)},n=function(f,y){var g,v;return y==null&&(y=i),g=f.pop(),f.length?(v=f[0],f[0]=g,b(f,0,y)):v=g,v},l=function(f,y,g){var v;return g==null&&(g=i),v=f[0],f[0]=y,b(f,0,g),v},a=function(f,y,g){var v;return g==null&&(g=i),f.length&&g(f[0],y)<0&&(v=[f[0],y],y=v[0],f[0]=v[1],b(f,0,g)),y},t=function(f,y){var g,v,k,x,M,A;for(y==null&&(y=i),x=(function(){A=[];for(var T=0,_=s(f.length/2);0<=_?T<_:T>_;0<=_?T++:T--)A.push(T);return A}).apply(this).reverse(),M=[],v=0,k=x.length;v<k;v++)g=x[v],M.push(b(f,g,y));return M},u=function(f,y,g){var v;if(g==null&&(g=i),v=f.indexOf(y),v!==-1)return m(f,0,v,g),b(f,v,g)},h=function(f,y,g){var v,k,x,M,A;if(g==null&&(g=i),k=f.slice(0,y),!k.length)return k;for(t(k,g),A=f.slice(y),x=0,M=A.length;x<M;x++)v=A[x],a(k,v,g);return k.sort(g).reverse()},p=function(f,y,g){var v,k,x,M,A,T,_,E,w;if(g==null&&(g=i),y*10<=f.length){if(x=f.slice(0,y).sort(g),!x.length)return x;for(k=x[x.length-1],_=f.slice(y),M=0,T=_.length;M<T;M++)v=_[M],g(v,k)<0&&(c(x,v,0,null,g),x.pop(),k=x[x.length-1]);return x}for(t(f,g),w=[],A=0,E=d(y,f.length);0<=E?A<E:A>E;0<=E?++A:--A)w.push(n(f,g));return w},m=function(f,y,g,v){var k,x,M;for(v==null&&(v=i),k=f[g];g>y;){if(M=g-1>>1,x=f[M],v(k,x)<0){f[g]=x,g=M;continue}break}return f[g]=k},b=function(f,y,g){var v,k,x,M,A;for(g==null&&(g=i),k=f.length,A=y,x=f[y],v=2*y+1;v<k;)M=v+1,M<k&&!(g(f[v],f[M])<0)&&(v=M),f[y]=f[v],y=v,v=2*y+1;return f[y]=x,m(f,A,y,g)},e=(function(){f.push=r,f.pop=n,f.replace=l,f.pushpop=a,f.heapify=t,f.updateItem=u,f.nlargest=h,f.nsmallest=p;function f(y){this.cmp=y??i,this.nodes=[]}return f.prototype.push=function(y){return r(this.nodes,y,this.cmp)},f.prototype.pop=function(){return n(this.nodes,this.cmp)},f.prototype.peek=function(){return this.nodes[0]},f.prototype.contains=function(y){return this.nodes.indexOf(y)!==-1},f.prototype.replace=function(y){return l(this.nodes,y,this.cmp)},f.prototype.pushpop=function(y){return a(this.nodes,y,this.cmp)},f.prototype.heapify=function(){return t(this.nodes,this.cmp)},f.prototype.updateItem=function(y){return u(this.nodes,y,this.cmp)},f.prototype.clear=function(){return this.nodes=[]},f.prototype.empty=function(){return this.nodes.length===0},f.prototype.size=function(){return this.nodes.length},f.prototype.clone=function(){var y;return y=new f,y.nodes=this.nodes.slice(0),y},f.prototype.toArray=function(){return this.nodes.slice(0)},f.prototype.insert=f.prototype.push,f.prototype.top=f.prototype.peek,f.prototype.front=f.prototype.peek,f.prototype.has=f.prototype.contains,f.prototype.copy=f.prototype.clone,f})(),o!==null&&o.exports?o.exports=e:window.Heap=e}).call(Gi)})(Ee)),Ee.exports}var Oe,At;function We(){return At||(At=1,Oe=Qi()),Oe}var qe,St;function bt(){if(St)return qe;St=1;function o(e,i,s){this.x=e,this.y=i,this.walkable=s===void 0?!0:s}return qe=o,qe}var He,Ct;function Z(){if(Ct)return He;Ct=1;var o={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4};return He=o,He}var Ve,Tt;function Zi(){if(Tt)return Ve;Tt=1;var o=bt(),e=Z();function i(s,t,n){var r;typeof s!="object"?r=s:(t=s.length,r=s[0].length,n=s),this.width=r,this.height=t,this.nodes=this._buildNodes(r,t,n)}return i.prototype._buildNodes=function(s,t,n){var r,a,l=new Array(t);for(r=0;r<t;++r)for(l[r]=new Array(s),a=0;a<s;++a)l[r][a]=new o(a,r);if(n===void 0)return l;if(n.length!==t||n[0].length!==s)throw new Error("Matrix size does not fit");for(r=0;r<t;++r)for(a=0;a<s;++a)n[r][a]&&(l[r][a].walkable=!1);return l},i.prototype.getNodeAt=function(s,t){return this.nodes[t][s]},i.prototype.isWalkableAt=function(s,t){return this.isInside(s,t)&&this.nodes[t][s].walkable},i.prototype.isInside=function(s,t){return s>=0&&s<this.width&&t>=0&&t<this.height},i.prototype.setWalkableAt=function(s,t,n){this.nodes[t][s].walkable=n},i.prototype.getNeighbors=function(s,t){var n=s.x,r=s.y,a=[],l=!1,c=!1,d=!1,h=!1,p=!1,u=!1,m=!1,b=!1,f=this.nodes;if(this.isWalkableAt(n,r-1)&&(a.push(f[r-1][n]),l=!0),this.isWalkableAt(n+1,r)&&(a.push(f[r][n+1]),d=!0),this.isWalkableAt(n,r+1)&&(a.push(f[r+1][n]),p=!0),this.isWalkableAt(n-1,r)&&(a.push(f[r][n-1]),m=!0),t===e.Never)return a;if(t===e.OnlyWhenNoObstacles)c=m&&l,h=l&&d,u=d&&p,b=p&&m;else if(t===e.IfAtMostOneObstacle)c=m||l,h=l||d,u=d||p,b=p||m;else if(t===e.Always)c=!0,h=!0,u=!0,b=!0;else throw new Error("Incorrect value of diagonalMovement");return c&&this.isWalkableAt(n-1,r-1)&&a.push(f[r-1][n-1]),h&&this.isWalkableAt(n+1,r-1)&&a.push(f[r-1][n+1]),u&&this.isWalkableAt(n+1,r+1)&&a.push(f[r+1][n+1]),b&&this.isWalkableAt(n-1,r+1)&&a.push(f[r+1][n-1]),a},i.prototype.clone=function(){var s,t,n=this.width,r=this.height,a=this.nodes,l=new i(n,r),c=new Array(r);for(s=0;s<r;++s)for(c[s]=new Array(n),t=0;t<n;++t)c[s][t]=new o(t,s,a[s][t].walkable);return l.nodes=c,l},Ve=i,Ve}var se={},Bt;function ce(){if(Bt)return se;Bt=1;function o(a){for(var l=[[a.x,a.y]];a.parent;)a=a.parent,l.push([a.x,a.y]);return l.reverse()}se.backtrace=o;function e(a,l){var c=o(a),d=o(l);return c.concat(d.reverse())}se.biBacktrace=e;function i(a){var l,c=0,d,h,p,u;for(l=1;l<a.length;++l)d=a[l-1],h=a[l],p=d[0]-h[0],u=d[1]-h[1],c+=Math.sqrt(p*p+u*u);return c}se.pathLength=i;function s(a,l,c,d){var h=Math.abs,p=[],u,m,b,f,y,g;for(b=h(c-a),f=h(d-l),u=a<c?1:-1,m=l<d?1:-1,y=b-f;p.push([a,l]),!(a===c&&l===d);)g=2*y,g>-f&&(y=y-f,a=a+u),g<b&&(y=y+b,l=l+m);return p}se.interpolate=s;function t(a){var l=[],c=a.length,d,h,p,u,m,b;if(c<2)return l;for(m=0;m<c-1;++m)for(d=a[m],h=a[m+1],p=s(d[0],d[1],h[0],h[1]),u=p.length,b=0;b<u-1;++b)l.push(p[b]);return l.push(a[c-1]),l}se.expandPath=t;function n(a,l){var c=l.length,d=l[0][0],h=l[0][1],p=l[c-1][0],u=l[c-1][1],m,b,f,y,g,v,k,x,M,A,T;for(m=d,b=h,g=[[m,b]],v=2;v<c;++v){for(x=l[v],f=x[0],y=x[1],M=s(m,b,f,y),T=!1,k=1;k<M.length;++k)if(A=M[k],!a.isWalkableAt(A[0],A[1])){T=!0;break}T&&(lastValidCoord=l[v-1],g.push(lastValidCoord),m=lastValidCoord[0],b=lastValidCoord[1])}return g.push([p,u]),g}se.smoothenPath=n;function r(a){if(a.length<3)return a;var l=[],c=a[0][0],d=a[0][1],h=a[1][0],p=a[1][1],u=h-c,m=p-d,b,f,y,g,v,k;for(v=Math.sqrt(u*u+m*m),u/=v,m/=v,l.push([c,d]),k=2;k<a.length;k++)b=h,f=p,y=u,g=m,h=a[k][0],p=a[k][1],u=h-b,m=p-f,v=Math.sqrt(u*u+m*m),u/=v,m/=v,(u!==y||m!==g)&&l.push([b,f]);return l.push([h,p]),l}return se.compressPath=r,se}var Ue,Dt;function _e(){return Dt||(Dt=1,Ue={manhattan:function(o,e){return o+e},euclidean:function(o,e){return Math.sqrt(o*o+e*e)},octile:function(o,e){var i=Math.SQRT2-1;return o<e?i*o+e:i*e+o},chebyshev:function(o,e){return Math.max(o,e)}}),Ue}var Ye,Pt;function vt(){if(Pt)return Ye;Pt=1;var o=We(),e=ce(),i=_e(),s=Z();function t(n){n=n||{},this.allowDiagonal=n.allowDiagonal,this.dontCrossCorners=n.dontCrossCorners,this.heuristic=n.heuristic||i.manhattan,this.weight=n.weight||1,this.diagonalMovement=n.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=s.OnlyWhenNoObstacles:this.diagonalMovement=s.IfAtMostOneObstacle:this.diagonalMovement=s.Never),this.diagonalMovement===s.Never?this.heuristic=n.heuristic||i.manhattan:this.heuristic=n.heuristic||i.octile}return t.prototype.findPath=function(n,r,a,l,c){var d=new o(function(E,w){return E.f-w.f}),h=c.getNodeAt(n,r),p=c.getNodeAt(a,l),u=this.heuristic,m=this.diagonalMovement,b=this.weight,f=Math.abs,y=Math.SQRT2,g,v,k,x,M,A,T,_;for(h.g=0,h.f=0,d.push(h),h.opened=!0;!d.empty();){if(g=d.pop(),g.closed=!0,g===p)return e.backtrace(p);for(v=c.getNeighbors(g,m),x=0,M=v.length;x<M;++x)k=v[x],!k.closed&&(A=k.x,T=k.y,_=g.g+(A-g.x===0||T-g.y===0?1:y),(!k.opened||_<k.g)&&(k.g=_,k.h=k.h||b*u(f(A-a),f(T-l)),k.f=k.g+k.h,k.parent=g,k.opened?d.updateItem(k):(d.push(k),k.opened=!0)))}return[]},Ye=t,Ye}var Xe,Rt;function es(){if(Rt)return Xe;Rt=1;var o=vt();function e(i){o.call(this,i);var s=this.heuristic;this.heuristic=function(t,n){return s(t,n)*1e6}}return e.prototype=new o,e.prototype.constructor=e,Xe=e,Xe}var ze,Ft;function ts(){if(Ft)return ze;Ft=1;var o=ce(),e=Z();function i(s){s=s||{},this.allowDiagonal=s.allowDiagonal,this.dontCrossCorners=s.dontCrossCorners,this.diagonalMovement=s.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=e.OnlyWhenNoObstacles:this.diagonalMovement=e.IfAtMostOneObstacle:this.diagonalMovement=e.Never)}return i.prototype.findPath=function(s,t,n,r,a){var l=[],c=this.diagonalMovement,d=a.getNodeAt(s,t),h=a.getNodeAt(n,r),p,u,m,b,f;for(l.push(d),d.opened=!0;l.length;){if(m=l.shift(),m.closed=!0,m===h)return o.backtrace(h);for(p=a.getNeighbors(m,c),b=0,f=p.length;b<f;++b)u=p[b],!(u.closed||u.opened)&&(l.push(u),u.opened=!0,u.parent=m)}return[]},ze=i,ze}var Je,Nt;function is(){if(Nt)return Je;Nt=1;var o=vt();function e(i){o.call(this,i),this.heuristic=function(s,t){return 0}}return e.prototype=new o,e.prototype.constructor=e,Je=e,Je}var Ke,Wt;function _t(){if(Wt)return Ke;Wt=1;var o=We(),e=ce(),i=_e(),s=Z();function t(n){n=n||{},this.allowDiagonal=n.allowDiagonal,this.dontCrossCorners=n.dontCrossCorners,this.diagonalMovement=n.diagonalMovement,this.heuristic=n.heuristic||i.manhattan,this.weight=n.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=s.OnlyWhenNoObstacles:this.diagonalMovement=s.IfAtMostOneObstacle:this.diagonalMovement=s.Never),this.diagonalMovement===s.Never?this.heuristic=n.heuristic||i.manhattan:this.heuristic=n.heuristic||i.octile}return t.prototype.findPath=function(n,r,a,l,c){var d=function(I,C){return I.f-C.f},h=new o(d),p=new o(d),u=c.getNodeAt(n,r),m=c.getNodeAt(a,l),b=this.heuristic,f=this.diagonalMovement,y=this.weight,g=Math.abs,v=Math.SQRT2,k,x,M,A,T,_,E,w,S=1,F=2;for(u.g=0,u.f=0,h.push(u),u.opened=S,m.g=0,m.f=0,p.push(m),m.opened=F;!h.empty()&&!p.empty();){for(k=h.pop(),k.closed=!0,x=c.getNeighbors(k,f),A=0,T=x.length;A<T;++A)if(M=x[A],!M.closed){if(M.opened===F)return e.biBacktrace(k,M);_=M.x,E=M.y,w=k.g+(_-k.x===0||E-k.y===0?1:v),(!M.opened||w<M.g)&&(M.g=w,M.h=M.h||y*b(g(_-a),g(E-l)),M.f=M.g+M.h,M.parent=k,M.opened?h.updateItem(M):(h.push(M),M.opened=S))}for(k=p.pop(),k.closed=!0,x=c.getNeighbors(k,f),A=0,T=x.length;A<T;++A)if(M=x[A],!M.closed){if(M.opened===S)return e.biBacktrace(M,k);_=M.x,E=M.y,w=k.g+(_-k.x===0||E-k.y===0?1:v),(!M.opened||w<M.g)&&(M.g=w,M.h=M.h||y*b(g(_-n),g(E-r)),M.f=M.g+M.h,M.parent=k,M.opened?p.updateItem(M):(p.push(M),M.opened=F))}}return[]},Ke=t,Ke}var Ge,$t;function ss(){if($t)return Ge;$t=1;var o=_t();function e(i){o.call(this,i);var s=this.heuristic;this.heuristic=function(t,n){return s(t,n)*1e6}}return e.prototype=new o,e.prototype.constructor=e,Ge=e,Ge}var Qe,jt;function ns(){if(jt)return Qe;jt=1;var o=ce(),e=Z();function i(s){s=s||{},this.allowDiagonal=s.allowDiagonal,this.dontCrossCorners=s.dontCrossCorners,this.diagonalMovement=s.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=e.OnlyWhenNoObstacles:this.diagonalMovement=e.IfAtMostOneObstacle:this.diagonalMovement=e.Never)}return i.prototype.findPath=function(s,t,n,r,a){var l=a.getNodeAt(s,t),c=a.getNodeAt(n,r),d=[],h=[],p,u,m,b=this.diagonalMovement,f=0,y=1,g,v;for(d.push(l),l.opened=!0,l.by=f,h.push(c),c.opened=!0,c.by=y;d.length&&h.length;){for(m=d.shift(),m.closed=!0,p=a.getNeighbors(m,b),g=0,v=p.length;g<v;++g)if(u=p[g],!u.closed){if(u.opened){if(u.by===y)return o.biBacktrace(m,u);continue}d.push(u),u.parent=m,u.opened=!0,u.by=f}for(m=h.shift(),m.closed=!0,p=a.getNeighbors(m,b),g=0,v=p.length;g<v;++g)if(u=p[g],!u.closed){if(u.opened){if(u.by===f)return o.biBacktrace(u,m);continue}h.push(u),u.parent=m,u.opened=!0,u.by=y}}return[]},Qe=i,Qe}var Ze,Lt;function os(){if(Lt)return Ze;Lt=1;var o=_t();function e(i){o.call(this,i),this.heuristic=function(s,t){return 0}}return e.prototype=new o,e.prototype.constructor=e,Ze=e,Ze}var et,Ot;function as(){if(Ot)return et;Ot=1,ce();var o=_e(),e=bt(),i=Z();function s(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.heuristic=t.heuristic||o.manhattan,this.weight=t.weight||1,this.trackRecursion=t.trackRecursion||!1,this.timeLimit=t.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=i.OnlyWhenNoObstacles:this.diagonalMovement=i.IfAtMostOneObstacle:this.diagonalMovement=i.Never),this.diagonalMovement===i.Never?this.heuristic=t.heuristic||o.manhattan:this.heuristic=t.heuristic||o.octile}return s.prototype.findPath=function(t,n,r,a,l){var c=new Date().getTime(),d=(function(v,k){return this.heuristic(Math.abs(k.x-v.x),Math.abs(k.y-v.y))}).bind(this),h=function(v,k){return v.x===k.x||v.y===k.y?1:Math.SQRT2},p=(function(v,k,x,M,A){if(this.timeLimit>0&&new Date().getTime()-c>this.timeLimit*1e3)return 1/0;var T=k+d(v,m)*this.weight;if(T>x)return T;if(v==m)return M[A]=[v.x,v.y],v;var _,E,w,S,F=l.getNeighbors(v,this.diagonalMovement);for(w=0,_=1/0;S=F[w];++w){if(this.trackRecursion&&(S.retainCount=S.retainCount+1||1,S.tested!==!0&&(S.tested=!0)),E=p(S,k+h(v,S),x,M,A+1),E instanceof e)return M[A]=[v.x,v.y],E;this.trackRecursion&&--S.retainCount===0&&(S.tested=!1),E<_&&(_=E)}return _}).bind(this),u=l.getNodeAt(t,n),m=l.getNodeAt(r,a),b=d(u,m),f,y,g;for(f=0;;++f){if(y=[],g=p(u,0,b,y,0),g===1/0)return[];if(g instanceof e)return y;b=g}return[]},et=s,et}var tt,qt;function $e(){if(qt)return tt;qt=1;var o=We(),e=ce(),i=_e();Z();function s(t){t=t||{},this.heuristic=t.heuristic||i.manhattan,this.trackJumpRecursion=t.trackJumpRecursion||!1}return s.prototype.findPath=function(t,n,r,a,l){var c=this.openList=new o(function(u,m){return u.f-m.f}),d=this.startNode=l.getNodeAt(t,n),h=this.endNode=l.getNodeAt(r,a),p;for(this.grid=l,d.g=0,d.f=0,c.push(d),d.opened=!0;!c.empty();){if(p=c.pop(),p.closed=!0,p===h)return e.expandPath(e.backtrace(h));this._identifySuccessors(p)}return[]},s.prototype._identifySuccessors=function(t){var n=this.grid,r=this.heuristic,a=this.openList,l=this.endNode.x,c=this.endNode.y,d,h,p,u,m,b=t.x,f=t.y,y,g,v,k,x,M=Math.abs;for(d=this._findNeighbors(t),u=0,m=d.length;u<m;++u)if(h=d[u],p=this._jump(h[0],h[1],b,f),p){if(y=p[0],g=p[1],x=n.getNodeAt(y,g),x.closed)continue;v=i.octile(M(y-b),M(g-f)),k=t.g+v,(!x.opened||k<x.g)&&(x.g=k,x.h=x.h||r(M(y-l),M(g-c)),x.f=x.g+x.h,x.parent=t,x.opened?a.updateItem(x):(a.push(x),x.opened=!0))}},tt=s,tt}var it,Ht;function rs(){if(Ht)return it;Ht=1;var o=$e(),e=Z();function i(s){o.call(this,s)}return i.prototype=new o,i.prototype.constructor=i,i.prototype._jump=function(s,t,n,r){var a=this.grid,l=s-n,c=t-r;if(!a.isWalkableAt(s,t))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(s,t).tested=!0),a.getNodeAt(s,t)===this.endNode)return[s,t];if(l!==0){if(a.isWalkableAt(s,t-1)&&!a.isWalkableAt(s-l,t-1)||a.isWalkableAt(s,t+1)&&!a.isWalkableAt(s-l,t+1))return[s,t]}else if(c!==0){if(a.isWalkableAt(s-1,t)&&!a.isWalkableAt(s-1,t-c)||a.isWalkableAt(s+1,t)&&!a.isWalkableAt(s+1,t-c))return[s,t];if(this._jump(s+1,t,s,t)||this._jump(s-1,t,s,t))return[s,t]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(s+l,t+c,s,t)},i.prototype._findNeighbors=function(s){var t=s.parent,n=s.x,r=s.y,a=this.grid,l,c,d,h,p=[],u,m,b,f;if(t)l=t.x,c=t.y,d=(n-l)/Math.max(Math.abs(n-l),1),h=(r-c)/Math.max(Math.abs(r-c),1),d!==0?(a.isWalkableAt(n,r-1)&&p.push([n,r-1]),a.isWalkableAt(n,r+1)&&p.push([n,r+1]),a.isWalkableAt(n+d,r)&&p.push([n+d,r])):h!==0&&(a.isWalkableAt(n-1,r)&&p.push([n-1,r]),a.isWalkableAt(n+1,r)&&p.push([n+1,r]),a.isWalkableAt(n,r+h)&&p.push([n,r+h]));else for(u=a.getNeighbors(s,e.Never),b=0,f=u.length;b<f;++b)m=u[b],p.push([m.x,m.y]);return p},it=i,it}var st,Vt;function ls(){if(Vt)return st;Vt=1;var o=$e(),e=Z();function i(s){o.call(this,s)}return i.prototype=new o,i.prototype.constructor=i,i.prototype._jump=function(s,t,n,r){var a=this.grid,l=s-n,c=t-r;if(!a.isWalkableAt(s,t))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(s,t).tested=!0),a.getNodeAt(s,t)===this.endNode)return[s,t];if(l!==0&&c!==0){if(a.isWalkableAt(s-l,t+c)&&!a.isWalkableAt(s-l,t)||a.isWalkableAt(s+l,t-c)&&!a.isWalkableAt(s,t-c))return[s,t];if(this._jump(s+l,t,s,t)||this._jump(s,t+c,s,t))return[s,t]}else if(l!==0){if(a.isWalkableAt(s+l,t+1)&&!a.isWalkableAt(s,t+1)||a.isWalkableAt(s+l,t-1)&&!a.isWalkableAt(s,t-1))return[s,t]}else if(a.isWalkableAt(s+1,t+c)&&!a.isWalkableAt(s+1,t)||a.isWalkableAt(s-1,t+c)&&!a.isWalkableAt(s-1,t))return[s,t];return this._jump(s+l,t+c,s,t)},i.prototype._findNeighbors=function(s){var t=s.parent,n=s.x,r=s.y,a=this.grid,l,c,d,h,p=[],u,m,b,f;if(t)l=t.x,c=t.y,d=(n-l)/Math.max(Math.abs(n-l),1),h=(r-c)/Math.max(Math.abs(r-c),1),d!==0&&h!==0?(a.isWalkableAt(n,r+h)&&p.push([n,r+h]),a.isWalkableAt(n+d,r)&&p.push([n+d,r]),a.isWalkableAt(n+d,r+h)&&p.push([n+d,r+h]),a.isWalkableAt(n-d,r)||p.push([n-d,r+h]),a.isWalkableAt(n,r-h)||p.push([n+d,r-h])):d===0?(a.isWalkableAt(n,r+h)&&p.push([n,r+h]),a.isWalkableAt(n+1,r)||p.push([n+1,r+h]),a.isWalkableAt(n-1,r)||p.push([n-1,r+h])):(a.isWalkableAt(n+d,r)&&p.push([n+d,r]),a.isWalkableAt(n,r+1)||p.push([n+d,r+1]),a.isWalkableAt(n,r-1)||p.push([n+d,r-1]));else for(u=a.getNeighbors(s,e.Always),b=0,f=u.length;b<f;++b)m=u[b],p.push([m.x,m.y]);return p},st=i,st}var nt,Ut;function cs(){if(Ut)return nt;Ut=1;var o=$e(),e=Z();function i(s){o.call(this,s)}return i.prototype=new o,i.prototype.constructor=i,i.prototype._jump=function(s,t,n,r){var a=this.grid,l=s-n,c=t-r;if(!a.isWalkableAt(s,t))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(s,t).tested=!0),a.getNodeAt(s,t)===this.endNode)return[s,t];if(l!==0&&c!==0){if(this._jump(s+l,t,s,t)||this._jump(s,t+c,s,t))return[s,t]}else if(l!==0){if(a.isWalkableAt(s,t-1)&&!a.isWalkableAt(s-l,t-1)||a.isWalkableAt(s,t+1)&&!a.isWalkableAt(s-l,t+1))return[s,t]}else if(c!==0&&(a.isWalkableAt(s-1,t)&&!a.isWalkableAt(s-1,t-c)||a.isWalkableAt(s+1,t)&&!a.isWalkableAt(s+1,t-c)))return[s,t];return a.isWalkableAt(s+l,t)&&a.isWalkableAt(s,t+c)?this._jump(s+l,t+c,s,t):null},i.prototype._findNeighbors=function(s){var t=s.parent,n=s.x,r=s.y,a=this.grid,l,c,d,h,p=[],u,m,b,f;if(t)if(l=t.x,c=t.y,d=(n-l)/Math.max(Math.abs(n-l),1),h=(r-c)/Math.max(Math.abs(r-c),1),d!==0&&h!==0)a.isWalkableAt(n,r+h)&&p.push([n,r+h]),a.isWalkableAt(n+d,r)&&p.push([n+d,r]),a.isWalkableAt(n,r+h)&&a.isWalkableAt(n+d,r)&&p.push([n+d,r+h]);else{var y;if(d!==0){y=a.isWalkableAt(n+d,r);var g=a.isWalkableAt(n,r+1),v=a.isWalkableAt(n,r-1);y&&(p.push([n+d,r]),g&&p.push([n+d,r+1]),v&&p.push([n+d,r-1])),g&&p.push([n,r+1]),v&&p.push([n,r-1])}else if(h!==0){y=a.isWalkableAt(n,r+h);var k=a.isWalkableAt(n+1,r),x=a.isWalkableAt(n-1,r);y&&(p.push([n,r+h]),k&&p.push([n+1,r+h]),x&&p.push([n-1,r+h])),k&&p.push([n+1,r]),x&&p.push([n-1,r])}}else for(u=a.getNeighbors(s,e.OnlyWhenNoObstacles),b=0,f=u.length;b<f;++b)m=u[b],p.push([m.x,m.y]);return p},nt=i,nt}var ot,Yt;function ds(){if(Yt)return ot;Yt=1;var o=$e(),e=Z();function i(s){o.call(this,s)}return i.prototype=new o,i.prototype.constructor=i,i.prototype._jump=function(s,t,n,r){var a=this.grid,l=s-n,c=t-r;if(!a.isWalkableAt(s,t))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(s,t).tested=!0),a.getNodeAt(s,t)===this.endNode)return[s,t];if(l!==0&&c!==0){if(a.isWalkableAt(s-l,t+c)&&!a.isWalkableAt(s-l,t)||a.isWalkableAt(s+l,t-c)&&!a.isWalkableAt(s,t-c))return[s,t];if(this._jump(s+l,t,s,t)||this._jump(s,t+c,s,t))return[s,t]}else if(l!==0){if(a.isWalkableAt(s+l,t+1)&&!a.isWalkableAt(s,t+1)||a.isWalkableAt(s+l,t-1)&&!a.isWalkableAt(s,t-1))return[s,t]}else if(a.isWalkableAt(s+1,t+c)&&!a.isWalkableAt(s+1,t)||a.isWalkableAt(s-1,t+c)&&!a.isWalkableAt(s-1,t))return[s,t];return a.isWalkableAt(s+l,t)||a.isWalkableAt(s,t+c)?this._jump(s+l,t+c,s,t):null},i.prototype._findNeighbors=function(s){var t=s.parent,n=s.x,r=s.y,a=this.grid,l,c,d,h,p=[],u,m,b,f;if(t)l=t.x,c=t.y,d=(n-l)/Math.max(Math.abs(n-l),1),h=(r-c)/Math.max(Math.abs(r-c),1),d!==0&&h!==0?(a.isWalkableAt(n,r+h)&&p.push([n,r+h]),a.isWalkableAt(n+d,r)&&p.push([n+d,r]),(a.isWalkableAt(n,r+h)||a.isWalkableAt(n+d,r))&&p.push([n+d,r+h]),!a.isWalkableAt(n-d,r)&&a.isWalkableAt(n,r+h)&&p.push([n-d,r+h]),!a.isWalkableAt(n,r-h)&&a.isWalkableAt(n+d,r)&&p.push([n+d,r-h])):d===0?a.isWalkableAt(n,r+h)&&(p.push([n,r+h]),a.isWalkableAt(n+1,r)||p.push([n+1,r+h]),a.isWalkableAt(n-1,r)||p.push([n-1,r+h])):a.isWalkableAt(n+d,r)&&(p.push([n+d,r]),a.isWalkableAt(n,r+1)||p.push([n+d,r+1]),a.isWalkableAt(n,r-1)||p.push([n+d,r-1]));else for(u=a.getNeighbors(s,e.IfAtMostOneObstacle),b=0,f=u.length;b<f;++b)m=u[b],p.push([m.x,m.y]);return p},ot=i,ot}var at,Xt;function hs(){if(Xt)return at;Xt=1;var o=Z(),e=rs(),i=ls(),s=cs(),t=ds();function n(r){return r=r||{},r.diagonalMovement===o.Never?new e(r):r.diagonalMovement===o.Always?new i(r):r.diagonalMovement===o.OnlyWhenNoObstacles?new s(r):new t(r)}return at=n,at}var rt,zt;function us(){return zt||(zt=1,rt={Heap:We(),Node:bt(),Grid:Zi(),Util:ce(),DiagonalMovement:Z(),Heuristic:_e(),AStarFinder:vt(),BestFirstFinder:es(),BreadthFirstFinder:ts(),DijkstraFinder:is(),BiAStarFinder:_t(),BiBestFirstFinder:ss(),BiBreadthFirstFinder:ns(),BiDijkstraFinder:os(),IDAStarFinder:as(),JumpPointFinder:hs()}),rt}var lt,Jt;function fs(){return Jt||(Jt=1,lt=us()),lt}var ps=fs();const di=Ki(ps);let we=null,Kt=null;function gs(o){if(we&&Kt===o.tiles)return we.clone();const e=[];for(let i=0;i<o.height;i++){e[i]=[];for(let s=0;s<o.width;s++){const t=o.tiles[i]?.[s];e[i][s]=t?.passable?0:1}}return we=new di.Grid(e),Kt=o.tiles,we.clone()}const ms=new di.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0});function Ae(o,e,i){const s=gs(o),t=Math.floor(e.x),n=Math.floor(e.y),r=Math.floor(i.x),a=Math.floor(i.y);if(t<0||t>=o.width||n<0||n>=o.height||r<0||r>=o.width||a<0||a>=o.height)return{path:[],success:!1,cost:1/0};try{const l=ms.findPath(t,n,r,a,s);if(l.length===0)return{path:[],success:!1,cost:1/0};const c=l.slice(1).map(d=>({x:d[0],y:d[1]}));return{path:c,success:!0,cost:c.length}}catch{return{path:[],success:!1,cost:1/0}}}function ys(o,e,i){let s=1;const t=`${o},${e}`;if(i.navigation.preferUnexplored>0&&(i.discoveredTiles.has(t)||(s*=1-i.navigation.preferUnexplored*.5)),i.navigation.avoidDanger>0&&i.enemyPositions.length>0){let n=0;for(const r of i.enemyPositions){const a=Math.sqrt((o-r.x)**2+(e-r.y)**2);a<8&&(n+=(8-a)/8)}s+=n*i.navigation.avoidDanger*2}return i.recentlyVisited?.has(t)&&(s*=1.5),s}function Gt(o,e,i,s){const t=Math.abs(i-o),n=Math.abs(s-e);return Math.max(t,n)+(Math.SQRT2-1)*Math.min(t,n)}function Qt(o,e,i,s){const t=Math.floor(e.x),n=Math.floor(e.y),r=Math.floor(i.x),a=Math.floor(i.y);if(t<0||t>=o.width||n<0||n>=o.height||r<0||r>=o.width||a<0||a>=o.height)return{path:[],success:!1,cost:1/0};const l=new Set,c=new Map,d=new Map,h=new Map,p=`${t},${n}`,u=`${r},${a}`;l.add(p),c.set(p,0),d.set(p,Gt(t,n,r,a));const m=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0},{dx:-1,dy:-1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:1,dy:1}];let b=0;const f=o.width*o.height*2;for(;l.size>0&&b<f;){b++;let y="",g=1/0;for(const A of l){const T=d.get(A)??1/0;T<g&&(g=T,y=A)}if(!y)break;if(y===u){const A=[];let T=y;for(;T&&T!==p;){const _=T.split(","),E=parseInt(_[0]??"0",10),w=parseInt(_[1]??"0",10);A.unshift({x:E,y:w}),T=h.get(T)}return{path:A,success:!0,cost:A.length}}l.delete(y);const v=y.split(","),k=parseInt(v[0]??"0",10),x=parseInt(v[1]??"0",10),M=c.get(y)??1/0;for(const A of m){const T=k+A.dx,_=x+A.dy,E=`${T},${_}`;if(T<0||T>=o.width||_<0||_>=o.height||!o.tiles[_]?.[T]?.passable)continue;if(A.dx!==0&&A.dy!==0){const C=o.tiles[x]?.[T],W=o.tiles[_]?.[k];if(!C?.passable||!W?.passable)continue}const S=A.dx!==0&&A.dy!==0?1.414:1,F=ys(T,_,s),I=M+S*F;I<(c.get(E)??1/0)&&(h.set(E,y),c.set(E,I),d.set(E,I+Gt(T,_,r,a)),l.add(E))}}return Ae(o,e,i)}function q(o,e){const i=e.x-o.x,s=e.y-o.y;return Math.sqrt(i*i+s*s)}function Se(o,e){const i=e.x-o.x,s=e.y-o.y,t=Math.sqrt(i*i+s*s);return t===0?{x:0,y:0}:{x:i/t,y:s/t}}function ue(o,e,i,s,t){if(i>=e.length)return{newPosition:o,newPathIndex:i};let r=s*(t/1e3),a={...o},l=i;for(;r>0&&l<e.length;){const c=e[l];if(!c)break;const d=q(a,c);if(d<=r)a={...c},r-=d,l++;else{const h=Se(a,c);a.x+=h.x*r,a.y+=h.y*r,r=0}}return{newPosition:a,newPathIndex:l}}function Ce(o,e,i){let s=Math.floor(e.x),t=Math.floor(e.y);const n=Math.floor(i.x),r=Math.floor(i.y),a=Math.abs(n-s),l=Math.abs(r-t),c=s<n?1:-1,d=t<r?1:-1;let h=a-l;for(;;){if(s<0||s>=o.width||t<0||t>=o.height||o.tiles[t]?.[s]?.blocksVision&&!(s===Math.floor(e.x)&&t===Math.floor(e.y)))return!1;if(s===n&&t===r)break;const u=2*h;u>-l&&(h-=l,s+=c),u<a&&(h+=a,t+=d)}return!0}function hi(o,e,i){const s=new Set,t=Math.floor(e.x),n=Math.floor(e.y);return new Wi.PreciseShadowcasting((a,l)=>a<0||a>=o.width||l<0||l>=o.height?!1:!o.tiles[l][a].blocksVision).compute(t,n,i,(a,l,c,d)=>{a>=0&&a<o.width&&l>=0&&l<o.height&&s.add(`${a},${l}`)}),s}function bs(o,e){const i=new Set(o);for(const s of e)i.add(s);return i}let ui=0;function vs(){ui=0}function _s(o){return`${o}_${++ui}`}function ks(o,e=ri,i){const s=Ne[e],t={...Hi};return s.baseStats&&Object.assign(t,s.baseStats),i&&Object.assign(t,i),{id:"player",type:"player",templateId:e,position:{...o},health:{integrity:t.maxIntegrity,shield:t.maxShield},stats:t,dead:!1,pathIndex:0,cooldownRemaining:0,faction:"player",skills:[...s.skills],skillCooldowns:new Map,statusEffects:[]}}function ws(o,e,i){const s=ni[o];if(!s)return console.warn(`Unknown mob template: ${o}`),null;const t=i?.isElite??!1,n=i?.isBoss??!1,r={...s.stats};t&&(r.maxIntegrity*=1.8,r.attackDamage*=1.4,r.armor*=1.3),n&&(r.maxIntegrity*=2.5,r.attackDamage*=1.6,r.armor*=1.5);const a={alerted:!1,threatTable:new Map,homePosition:{...e},ticksSinceTarget:0};return{id:_s(o),type:"mob",templateId:o,position:{...e},health:{integrity:r.maxIntegrity,shield:r.maxShield},stats:r,dead:!1,pathIndex:0,cooldownRemaining:0,faction:"enemy",isElite:t,isBoss:n,aggro:a,skills:[...s.skills],skillCooldowns:new Map,statusEffects:[]}}function Ms(o,e){const i=[];if(!ni[o.mobTemplateId])return console.warn(`Unknown mob template in spawn point: ${o.mobTemplateId}`),i;for(let t=0;t<o.mobCount;t++){const n=(e.next()-.5)*2,r=(e.next()-.5)*2,a={x:o.position.x+n,y:o.position.y+r},l=ws(o.mobTemplateId,a,{...o.isElite!==void 0&&{isElite:o.isElite},...o.isBoss!==void 0&&{isBoss:o.isBoss}});l&&(o.spawnedEntityIds.push(l.id),i.push(l))}return i}function xs(o,e){const i=`${e.type}_${Date.now()}`;o.statusEffects.push({...e,id:i})}function Me(o){let e=1;for(const i of o.statusEffects)i.type==="slow"&&(e*=1-i.value),i.type==="stun"&&(e=0);return e}function ct(o){return o.statusEffects.some(e=>e.type==="stun")}const Te=Xi();function Is(o,e,i,s){if(o.type!=="player"){const l=o.skills[0]??"melee_strike";return{skillId:l,skill:Te[l]}}const t=[...i.skillRules].filter(l=>l.enabled).sort((l,c)=>c.priority-l.priority),n=o.health.integrity/o.stats.maxIntegrity,r=e.health.integrity/e.stats.maxIntegrity,a=s.filter(l=>!l.dead&&q(o.position,l.position)<=o.stats.attackRange+2).length;for(const l of t){const c=Te[l.skillId];if(!(!c||(o.skillCooldowns.get(l.skillId)??0)>0||q(o.position,e.position)>c.range)&&!(l.minEnemiesNearby!==void 0&&a<l.minEnemiesNearby)&&!(l.maxEnemiesNearby!==void 0&&a>l.maxEnemiesNearby)&&!(l.onlyVsBoss&&!e.isBoss)&&!(l.onlyVsElite&&!e.isElite&&!e.isBoss)&&!(l.notVsBoss&&e.isBoss)&&!(l.targetHpAbove!==void 0&&r<=l.targetHpAbove)&&!(l.targetHpBelow!==void 0&&r>=l.targetHpBelow)&&!(l.selfHpAbove!==void 0&&n<=l.selfHpAbove)&&!(l.selfHpBelow!==void 0&&n>=l.selfHpBelow))return{skillId:l.skillId,skill:c}}for(const l of o.skills){const c=i.skillRules.find(h=>h.skillId===l);if(c&&!c.enabled||c&&!!(c.minEnemiesNearby||c.maxEnemiesNearby||c.onlyVsBoss||c.onlyVsElite||c.notVsBoss||c.targetHpAbove!==void 0||c.targetHpBelow!==void 0||c.selfHpAbove!==void 0||c.selfHpBelow!==void 0))continue;if((o.skillCooldowns.get(l)??0)<=0)return{skillId:l,skill:Te[l]}}return{skillId:"",skill:void 0}}function Es(o={}){const e={...Ei,...o};vs();const i=new oi(e.seed),s=ci({seed:e.seed,width:e.mapWidth,height:e.mapHeight,roomCount:e.roomCount,mobDensity:e.mobDensity,biome:e.biome}),t=e.playerClass??ri,n=e.strategyProfile??Yi,r=e.skillRules??li(t),a=ks(s.playerStart,t,e.playerStats),l=new Map;l.set(a.id,a);const c=s.spawnPoints.map(p=>({...p,spawnedEntityIds:[]})),d=hi(s,a.position,a.stats.visionRadius),h=new Set(d);return{tick:0,timeMs:0,rng:i,map:s,entities:l,projectiles:[],spawnPoints:c,treasures:s.treasures.map(p=>({...p})),eventLog:[],playerVision:d,discoveredTiles:h,complete:!1,outcome:"running",config:e,strategyProfile:n,playerClass:t,skillRules:r,metrics:{mobsKilled:0,damageDealt:0,damageTaken:0,critCount:0,treasureCollected:0,treasureValue:0}}}function kt(o){if(o.complete)return o;const e={...o,tick:o.tick+1,timeMs:o.timeMs+re,entities:new Map(o.entities),projectiles:[...o.projectiles],treasures:o.treasures.map(_=>({..._})),eventLog:[...o.eventLog],spawnPoints:o.spawnPoints.map(_=>({..._,spawnedEntityIds:[..._.spawnedEntityIds]})),metrics:{...o.metrics}},i=e.entities.get("player");if(!i||i.dead)return e.complete=!0,e.outcome="defeat",e;As(e),e.playerVision=hi(e.map,i.position,i.stats.visionRadius),e.discoveredTiles=bs(e.discoveredTiles,e.playerVision);for(const _ of e.spawnPoints)if(_.state==="dormant"&&q(i.position,_.position)<=_.triggerRadius){_.state="active";const w=Ms(_,e.rng);for(const S of w)e.entities.set(S.id,S),j(e,"mob_spawned",{entityId:S.id,templateId:S.templateId,position:S.position,isElite:S.isElite,isBoss:S.isBoss})}for(const[_,E]of e.entities){if(E.type!=="mob"||E.dead||ct(E))continue;const w=E,S=w.aggro;if(!S.alerted){const F=q(w.position,i.position),I=Ce(e.map,w.position,i.position);F<=w.stats.aggroRadius&&I&&(S.alerted=!0,S.threatTable.set("player",1),w.currentTarget="player",j(e,"mob_aggro",{entityId:w.id,targetId:"player"}),Ss(e,w))}if(S.alerted){const F=q(w.position,i.position);if(q(w.position,S.homePosition)>w.stats.leashRadius){S.alerted=!1,S.threatTable.clear(),delete w.currentTarget,delete w.path,j(e,"mob_leash",{entityId:w.id});continue}if(!Ce(e.map,w.position,i.position)&&F>w.stats.visionRadius){if(S.ticksSinceTarget++,S.ticksSinceTarget>Ci){S.alerted=!1,S.threatTable.clear(),delete w.currentTarget,delete w.path;continue}}else S.ticksSinceTarget=0;if(F>w.stats.attackRange){if(!w.path||w.pathIndex>=w.path.length){const W=Ae(e.map,w.position,i.position);W.success&&(w.path=W.path,w.pathIndex=0)}if(w.path&&w.pathIndex<w.path.length){const W=Me(w),{newPosition:J,newPathIndex:$}=ue(w.position,w.path,w.pathIndex,w.stats.moveSpeed*W,re);w.position=J,w.pathIndex=$}}}else if(q(w.position,S.homePosition)>1){if(!w.path||w.pathIndex>=w.path.length){const I=Ae(e.map,w.position,S.homePosition);I.success&&(w.path=I.path,w.pathIndex=0)}if(w.path&&w.pathIndex<w.path.length){const{newPosition:I,newPathIndex:C}=ue(w.position,w.path,w.pathIndex,w.stats.moveSpeed*.5,re);w.position=I,w.pathIndex=C}}e.entities.set(_,w)}if(!ct(i)){const _=i.lastMoveTick??0,E=i.lastDamageTick??0,w=Math.max(_,E),S=e.tick-w;S>0&&S%20===0&&(delete i.path,delete i.currentTarget,j(e,"anti_stuck",{ticksSinceActivity:S}));const F=i.lastDamageTick??e.tick,I=e.tick-F,C=Array.from(e.entities.values()).filter(B=>B.type==="mob"&&!B.dead&&B.aggro?.alerted),W=i.lastDamageTick!==void 0,J=C.filter(B=>q(i.position,B.position)<=B.stats.attackRange+2),$=W&&C.length>0&&J.length===0&&I>60;if(C.length>0&&!$){const B=e.strategyProfile.combat.targetPriority;C.sort((P,V)=>{const Y=q(i.position,P.position),N=q(i.position,V.position);switch(B){case"weakest":const H=P.health.integrity-V.health.integrity;return H!==0?H:Y-N;case"strongest":const O=V.health.integrity-P.health.integrity;return O!==0?O:Y-N;case"elite_first":return P.isElite&&!V.isElite?-1:V.isElite&&!P.isElite?1:P.isBoss&&!V.isBoss?-1:V.isBoss&&!P.isBoss?1:Y-N;case"boss_first":return P.isBoss&&!V.isBoss?-1:V.isBoss&&!P.isBoss?1:P.isElite&&!V.isElite?-1:V.isElite&&!P.isElite?1:Y-N;default:return Y-N}});const D=C[0];if(D){const P=q(i.position,D.position),V=i.health.integrity/i.stats.maxIntegrity;if(I>30&&I%30===0&&(delete i.path,delete i.currentTarget,j(e,"combat_stall",{ticksSinceDamage:I,targetId:D.id})),i.currentTarget!==D.id&&delete i.path,e.config.enableKiting&&V<e.config.kiteThreshold&&P<i.stats.attackRange*.8){const N=Se(D.position,i.position),H={x:i.position.x+N.x*e.config.kiteDistance,y:i.position.y+N.y*e.config.kiteDistance},O=Math.floor(H.x),G=Math.floor(H.y);if(O>=0&&O<e.map.width&&G>=0&&G<e.map.height&&e.map.tiles[G]?.[O]?.passable){const ae=Me(i),{newPosition:Ii}=ue(i.position,[H],0,i.stats.moveSpeed*ae,re);i.position=Ii,i.lastMoveTick=e.tick,j(e,"player_kite",{position:i.position})}}else if(P>i.stats.attackRange){if(e.tick%30===0&&delete i.path,!i.path||i.pathIndex>=i.path.length){const N=Ae(e.map,i.position,D.position);if(N.success)i.path=N.path,i.pathIndex=0;else{const H=Se(i.position,D.position),O={x:i.position.x+H.x,y:i.position.y+H.y},G=Math.floor(O.x),ae=Math.floor(O.y);G>=0&&G<e.map.width&&ae>=0&&ae<e.map.height&&e.map.tiles[ae]?.[G]?.passable&&(i.path=[O],i.pathIndex=0)}}if(i.path&&i.pathIndex<i.path.length){const N=Me(i),{newPosition:H,newPathIndex:O}=ue(i.position,i.path,i.pathIndex,i.stats.moveSpeed*N,re);i.position=H,i.pathIndex=O,i.lastMoveTick=e.tick,j(e,"player_move",{position:i.position})}}i.currentTarget=D.id}}else{const B=e.strategyProfile;e.tick%50===0&&delete i.path;let D=null,P="exit";if(B.objectives.findAllTreasure){const Y=e.treasures.filter(N=>!N.collected);if(Y.length>0){Y.sort((H,O)=>q(i.position,H.position)-q(i.position,O.position));const N=Y[0];N&&(D=N.position,P="treasure")}}if(B.objectives.killBoss&&!D){const Y=Array.from(e.entities.values()).find(N=>N.type==="mob"&&N.isBoss&&!N.dead);Y&&(D=Y.position,P="boss")}if(D||(D=e.map.exitPoint,P="exit"),q(i.position,D)>1){if(!i.path||i.pathIndex>=i.path.length){const Y=Array.from(e.entities.values()).filter(O=>O.type==="mob"&&!O.dead).map(O=>O.position),N={discoveredTiles:e.discoveredTiles,enemyPositions:Y,navigation:e.strategyProfile.navigation};let H=Qt(e.map,i.position,D,N);if(!H.success){const O=e.spawnPoints.filter(G=>G.state==="dormant");O.sort((G,ae)=>q(i.position,G.position)-q(i.position,ae.position));for(const G of O)if(H=Qt(e.map,i.position,G.position,N),H.success){j(e,"reroute_spawn",{spawnId:G.id});break}}H.success&&(i.path=H.path,i.pathIndex=0)}if(i.path&&i.pathIndex<i.path.length){const Y=Me(i),{newPosition:N,newPathIndex:H}=ue(i.position,i.path,i.pathIndex,i.stats.moveSpeed*Y,re);i.position=N,i.pathIndex=H,i.lastMoveTick=e.tick,j(e,"player_move",{position:i.position,target:P})}}delete i.currentTarget}if(S>20&&!i.path||S>60){delete i.path;const B=[{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:-1},{dx:1,dy:1},{dx:-1,dy:1},{dx:-1,dy:-1}];for(let D=B.length-1;D>0;D--){const P=Math.floor(e.rng.next()*(D+1));[B[D],B[P]]=[B[P],B[D]]}for(const D of B){const P=Math.floor(i.position.x)+D.dx,V=Math.floor(i.position.y)+D.dy;if(P>=0&&P<e.map.width&&V>=0&&V<e.map.height&&e.map.tiles[V]?.[P]?.passable){i.position={x:P+.5,y:V+.5},i.lastMoveTick=e.tick,j(e,"random_walk",{position:i.position,ticksSinceActivity:S});break}}}e.entities.set("player",i)}const s=e.entities.get("player");if(s&&!s.dead)for(const _ of e.treasures){if(_.collected)continue;q(s.position,_.position)<1.5&&(_.collected=!0,e.metrics.treasureCollected++,e.metrics.treasureValue+=_.value,j(e,"treasure_collected",{treasureId:_.id,type:_.type,value:_.value,totalCollected:e.metrics.treasureCollected,totalValue:e.metrics.treasureValue}))}const t=Array.from(e.entities.values()).filter(_=>_.type==="mob"&&!_.dead);for(const[_,E]of e.entities){if(E.dead||ct(E))continue;for(const[D,P]of E.skillCooldowns)P>0&&E.skillCooldowns.set(D,P-1);if(E.cooldownRemaining>0&&E.cooldownRemaining--,!E.currentTarget)continue;const w=e.entities.get(E.currentTarget);if(!w||w.dead){delete E.currentTarget;continue}if(q(E.position,w.position)>E.stats.attackRange||!Ce(e.map,E.position,w.position))continue;const{skillId:F,skill:I}=Is(E,w,e,t);if((E.skillCooldowns.get(F)??0)>0)continue;const W=I?.damage??E.stats.attackDamage,J=1+(e.rng.next()*2-1)*E.stats.damageVariance;let $=Math.floor(W*J);const B=e.rng.next()<E.stats.critChance;if(B&&($=Math.floor($*E.stats.critMultiplier),e.metrics.critCount++),I?.isProjectile){const D={id:`proj_${e.tick}_${_}`,sourceId:_,targetId:w.id,position:{...E.position},targetPosition:{...w.position},speed:I.projectileSpeed??Ti,damage:$,damageType:I.damageType,skillId:F,isCrit:B};e.projectiles.push(D),j(e,"projectile_fired",{sourceId:_,targetId:w.id,skillId:F,skillName:I.name})}else Zt(e,E,w,$,B,F);E.skillCooldowns.set(F,I?.cooldown??E.stats.attackCooldown),e.entities.set(_,E)}const n=[];for(const _ of e.projectiles){const E=e.entities.get(_.targetId),w=_.speed*(re/1e3),S=E&&!E.dead?E.position:_.targetPosition,F=Se(_.position,S);_.position.x+=F.x*w,_.position.y+=F.y*w;const I=Math.floor(_.position.x),C=Math.floor(_.position.y);if(I<0||I>=e.map.width||C<0||C>=e.map.height||!e.map.tiles[C]?.[I]?.passable){j(e,"projectile_hit_wall",{projectileId:_.id});continue}const W=q(_.position,S);if(W<.5){if(E&&!E.dead){const $=e.entities.get(_.sourceId);$&&Zt(e,$,E,_.damage,_.isCrit,_.skillId)}continue}if(W>20)continue;const J=parseInt(_.id.split("_")[1]||"0");e.tick-J>30||n.push(_)}e.projectiles=n;const r=e.entities.get("player");if(r&&r.dead)return e.complete=!0,e.outcome="defeat",j(e,"defeat",{}),e;const a=Array.from(e.entities.values()).filter(_=>_.type==="mob"&&!_.dead),l=a.filter(_=>_.aggro?.alerted),c=r?q(r.position,e.map.exitPoint)<2:!1,d=l.length===0,h=a.length===0,p=e.strategyProfile,u=p.objectives.clearAllMobs,m=Array.from(e.entities.values()).filter(_=>_.type==="mob").every(_=>_.dead),b=!u||m,f=p.objectives.killBoss,y=Array.from(e.entities.values()).filter(_=>_.type==="mob"&&_.isBoss),g=y.length===0||y.every(_=>_.dead),v=!f||g,k=p.objectives.findAllTreasure,x=e.treasures.every(_=>_.collected);return c&&d&&(b&&v&&(!k||x))?(e.complete=!0,e.outcome="victory",j(e,"victory",{tick:e.tick,reason:"exit_reached",clearMobs:u?m:"not_required",bossKilled:f?g:"not_required",treasureCollected:k?x:"not_required"}),e):e.spawnPoints.every(_=>_.state!=="dormant")&&h&&c?(e.complete=!0,e.outcome="victory",j(e,"victory",{tick:e.tick,reason:"full_clear"}),e):(e.tick>=Ai&&(e.complete=!0,e.outcome="defeat",j(e,"timeout",{})),e)}function Zt(o,e,i,s,t,n){const r=Math.min(.8,i.stats.armor/(i.stats.armor+100)),a=Math.floor(s*(1-r));let l=a;if(i.health.shield>0){const d=Math.min(i.health.shield,l);i.health.shield-=d,l-=d}i.health.integrity-=l,e.type==="player"?(o.metrics.damageDealt+=a,e.lastDamageTick=o.tick,o.entities.set(e.id,e)):i.type==="player"&&(o.metrics.damageTaken+=a),j(o,"attack",{attackerId:e.id,targetId:i.id,damage:a,isCrit:t,skillId:n,targetHpAfter:i.health.integrity});const c=Te[n];c?.statusEffect&&o.rng.next()<.8&&(xs(i,{type:c.statusEffect.type,remainingTicks:c.statusEffect.duration,value:c.statusEffect.value,sourceId:e.id}),j(o,"status_applied",{targetId:i.id,effectType:c.statusEffect.type,duration:c.statusEffect.duration})),i.health.integrity<=0&&(i.dead=!0,i.type==="mob"&&o.metrics.mobsKilled++,j(o,"entity_died",{entityId:i.id,killerId:e.id})),o.entities.set(i.id,i)}function As(o){for(const[e,i]of o.entities){if(i.dead)continue;const s=[];for(const t of i.statusEffects)t.type==="dot"&&(i.health.integrity-=t.value,j(o,"dot_tick",{entityId:e,damage:t.value,hpAfter:i.health.integrity}),i.health.integrity<=0&&(i.dead=!0,i.type==="mob"&&o.metrics.mobsKilled++,j(o,"entity_died",{entityId:e,killerId:t.sourceId,fromDoT:!0}))),t.remainingTicks--,t.remainingTicks>0?s.push(t):j(o,"status_expired",{entityId:e,effectType:t.type});i.statusEffects=s,o.entities.set(e,i)}}function Ss(o,e){for(const[i,s]of o.entities)s.type!=="mob"||s.dead||i===e.id||s.aggro?.alerted||q(e.position,s.position)>Si||Ce(o.map,e.position,s.position)&&(s.aggro.alerted=!0,s.aggro.threatTable.set("player",1),s.currentTarget="player",j(o,"aggro_chain",{sourceId:e.id,alertedId:s.id}),o.entities.set(i,s))}function j(o,e,i){o.eventLog.push({tick:o.tick,type:e,payload:i})}const ei={[R.Floor]:".",[R.Wall]:"#",[R.Hazard]:"~",[R.Water]:"",[R.Void]:" ",[R.Door]:"+",[R.Breakable]:""},Cs={player:"@",mob:"e",elite:"E",boss:"B",drone:"d",projectile:"*",aoe:""};function Ts(o,e,i,s,t=[],n=[]){const r=[],a=new Set;for(const c of t){const d=Math.floor(c.position.x),h=Math.floor(c.position.y);a.add(`${d},${h}`)}const l=new Map;for(const c of n)if(!c.collected){const d=Math.floor(c.position.x),h=Math.floor(c.position.y);l.set(`${d},${h}`,c)}for(let c=0;c<o.height;c++){let d="";for(let h=0;h<o.width;h++){const p=`${h},${c}`,u=e.find(b=>Math.floor(b.position.x)===h&&Math.floor(b.position.y)===c&&!b.dead),m=a.has(p);if(u&&i.has(p)){let b=Cs[u.type]||"?";if(u.type==="mob"&&(u.isBoss?b="B":u.isElite&&(b="E")),u.type==="player"&&u.statusEffects.length>0){const f=u.statusEffects.some(g=>g.type==="dot"),y=u.statusEffects.some(g=>g.type==="slow");f?b="":y&&(b="")}d+=b}else if(m&&i.has(p))d+="*";else if(i.has(p))if(l.get(p))d+="$";else if(Math.floor(o.exitPoint.x)===h&&Math.floor(o.exitPoint.y)===c)d+=">";else{const y=o.tiles[c]?.[h];d+=y?ei[y.type]:"?"}else if(s.has(p)){const b=o.tiles[c]?.[h];if(b){const f=ei[b.type];d+=`<span class="dim">${f}</span>`}else d+=" "}else d+=" "}r.push(d)}return r.join(`
`)}function Bs(o,e,i,s,t="running"){const n=e?`${Math.floor(e.health.integrity)}/${e.stats.maxIntegrity}`:"DEAD",r=e?`${Math.floor(e.health.shield)}`:"0",a=e?.statusEffects.length??0,l=a>0?` [${a}fx]`:"";let c="";return t==="victory"?c="  VICTORY":t==="defeat"&&(c="  DEFEAT"),`Tick: ${o.toString().padStart(4,"0")} | HP: ${n} | Shield: ${r}${l} | Mobs: ${i} | Speed: ${s}x${c}`}function Ds(o){const e=o.metrics,s=Ne[o.playerClass]?.name??o.playerClass,t=o.treasures.length,n=e.treasureCollected;return`Class: ${s} | Treasure: ${n}/${t} | Kills: ${e.mobsKilled} | Crits: ${e.critCount}`}function Ps(o){const e=`T${o.tick.toString().padStart(4,"0")}:`;switch(o.type){case"player_move":return`${e} @ moved`;case"player_kite":return`${e} @ KITING back`;case"attack":{const i=o.payload.damage,s=o.payload.isCrit?" CRIT!":"";return`${e} ${o.payload.attackerId}  ${o.payload.targetId} (${Math.floor(i)} dmg${s})`}case"projectile_fired":return`${e}  ${o.payload.skillId} fired`;case"projectile_hit_wall":return`${e} * hit wall`;case"entity_died":{const i=o.payload.fromDoT?" (DoT)":"";return`${e}  ${o.payload.entityId} killed${i}`}case"mob_spawned":{const i=o.payload.isElite?" [ELITE]":"",s=o.payload.isBoss?" [BOSS]":"";return`${e} + ${o.payload.templateId}${i}${s}`}case"mob_aggro":return`${e} ! ${o.payload.entityId} aggro'd`;case"aggro_chain":return`${e} !! Chain: ${o.payload.alertedId}`;case"mob_leash":return`${e}  ${o.payload.entityId} leashed`;case"status_applied":return`${e}  ${o.payload.effectType} on ${o.payload.targetId}`;case"status_expired":return`${e}  ${o.payload.effectType} expired`;case"dot_tick":return`${e}  DoT ${o.payload.damage} dmg`;case"treasure_collected":return`${e}  Got ${o.payload.type}! (+${o.payload.value})`;case"victory":return`${e}  VICTORY!`;case"defeat":return`${e}  DEFEAT`;case"timeout":return`${e}  TIMEOUT`;default:return`${e} ${o.type}`}}function Rs(o,e){const{map:i,entities:s,playerVision:t,discoveredTiles:n,projectiles:r,tick:a,outcome:l}=o,c=s.get("player"),d=Array.from(s.values()),h=d.filter(g=>g.type==="mob"&&!g.dead).length,p=o.eventLog.slice(-8),u=[],m=i.width+2;u.push(""+"".repeat(m)+"");const b=Bs(a,c,h,e,l);u.push(" "+b.slice(0,m-1).padEnd(m-1)+"");const f=Ds(o);u.push(" "+f.slice(0,m-1).padEnd(m-1)+""),u.push(""+"".repeat(m)+"");const y=Ts(i,d,t,n,r,o.treasures);for(const g of y.split(`
`))u.push(" "+g+" ");u.push(""+"".repeat(m)+"");for(const g of p){const v=Ps(g);u.push(" "+v.slice(0,m-1).padEnd(m-1)+"")}for(let g=p.length;g<8;g++)u.push(" "+" ".repeat(m-1)+"");return u.push(""+"".repeat(m)+""),u.join(`
`)}function Fs(o,e){let i="stopped",s=0,t=1,n=null;const r=()=>100/t,a=()=>{e({status:i,currentTick:s,speed:t})},l=()=>{i==="playing"&&(s++,o(),a(),n=window.setTimeout(l,r()))};return{getState(){return{status:i,currentTick:s,speed:t}},play(){i!=="playing"&&(i="playing",a(),n=window.setTimeout(l,r()))},pause(){i="paused",n&&(clearTimeout(n),n=null),a()},stop(){i="stopped",s=0,n&&(clearTimeout(n),n=null),a()},stepForward(){s++,o(),a()},stepBackward(){s>0&&(s--,a())},setSpeed(c){t=c,a()},seekToTick(c){s=Math.max(0,c),a()}}}const te=[.25,.5,1,2,4],Be=["","","","~","-"],De=["","","","|"],Ns=20,Ws=50;function $s(o){const e=[];for(let s=0;s<o.height;s++){e[s]=[];for(let t=0;t<o.width;t++){const n=o.tiles[s]?.[t];e[s][t]=n?.type===R.Floor}}const i={particles:[],frame:0,biome:o.biome??"rust_tides",floorMask:e,width:o.width,height:o.height};if(i.biome==="rust_tides")for(let s=0;s<Ns;s++)i.particles.push({x:Math.random()*o.width,y:1+Math.floor(Math.random()*(o.height-2)),speed:.6+Math.random()*.3,char:Be[Math.floor(Math.random()*Be.length)]});if(i.biome==="glass_flood")for(let s=0;s<Ws;s++)i.particles.push({x:1+Math.floor(Math.random()*(o.width-2)),y:Math.random()*o.height,speed:.8+Math.random()*.4,char:De[Math.floor(Math.random()*De.length)]});return i}function js(o){for(const e of o.particles)e.x+=e.speed,e.y+=(Math.random()-.5)*.2,e.x>=o.width-1&&(e.x=0,e.y=1+Math.floor(Math.random()*(o.height-2)),e.speed=.6+Math.random()*.3,e.char=Be[Math.floor(Math.random()*Be.length)]),e.y<1&&(e.y=1),e.y>=o.height-1&&(e.y=o.height-2)}function Ls(o){for(const e of o.particles)e.y+=e.speed,e.y>=o.height-1&&(e.y=0,e.x=1+Math.floor(Math.random()*(o.width-2)),e.char=De[Math.floor(Math.random()*De.length)])}function Os(o){o.frame++;const e=gt[o.biome];!e?.weather||e.weather==="none"||(e.weather==="wind"?js(o):e.weather==="rain"&&Ls(o))}function qs(o){const e=gt[o.biome];if(!e?.weather||e.weather==="none")return"";const i=[];for(let t=0;t<o.height;t++)i[t]=new Array(o.width).fill(" ");for(const t of o.particles){const n=Math.floor(t.x),r=Math.floor(t.y);r>=0&&r<o.height&&n>=1&&n<o.width-1&&o.floorMask[r]?.[n]&&(i[r][n]=t.char)}let s="";for(let t=0;t<o.height;t++)s+=i[t].join("")+`
`;return s}const Hs={slash:{frames:["\\","\\","","","/","/","","*","*",""],color:"attack",duration:10},spin:{frames:["","","","","","","","","","",""],color:"attack",duration:11},thrust:{frames:["","","","","","*","*",""],color:"impact",duration:8}},Vs={arrow:{chars:["","","","","","","","",""],color:"attack"},piercing:{chars:["","","","","","","",""],color:"attack"},multishot:{chars:["","","","","***","***",""],color:"attack"}},Us={bolt:{frames:["","","",""],color:"magic"},explosion:{frames:[".","*","**","******","'''"],color:"fire"},ice:{frames:["","","","**",""],color:"ice"}},fi={warrior_slash:{type:"melee",anim:"slash"},warrior_cleave:{type:"melee",anim:"spin"},warrior_shield_bash:{type:"melee",anim:"thrust"},ranger_shot:{type:"ranged",anim:"arrow"},ranger_piercing:{type:"ranged",anim:"piercing"},ranger_multishot:{type:"ranged",anim:"multishot"},mage_bolt:{type:"ranged",anim:"bolt"},mage_fireball:{type:"magic",anim:"explosion"},mage_blizzard:{type:"magic",anim:"ice"}};let le=[],Ys=0;function Xs(o,e,i){const s=fi[o];if(!s)return null;let t=[],n="attack",r=5;if(s.type==="melee"){const l=Hs[s.anim];l&&(t=l.frames,n=l.color,r=l.duration)}else if(s.type==="ranged"){const l=Vs[s.anim];l&&(t=l.chars,n=l.color,r=t.length)}else if(s.type==="magic"){const l=Us[s.anim];l&&(t=l.frames,n=l.color,r=t.length)}if(t.length===0)return null;const a={id:`effect_${++Ys}`,skillId:o,sourcePos:{...e},targetPos:{...i},frame:0,maxFrames:r,chars:t,color:n};return le.push(a),a}function zs(){for(let o=le.length-1;o>=0;o--){const e=le[o];e.frame++,e.frame>=e.maxFrames&&le.splice(o,1)}}function Js(){le=[]}function Ks(o,e){if(le.length===0)return"";const i=[];for(let t=0;t<e;t++)i[t]=new Array(o).fill(null).map(()=>({char:" ",color:""}));for(const t of le){const n=t.chars[Math.min(t.frame,t.chars.length-1)]||"*",r=fi[t.skillId];let a=Math.floor(t.targetPos.x),l=Math.floor(t.targetPos.y);if(r?.type==="ranged"&&t.maxFrames>1){const c=t.frame/(t.maxFrames-1);a=Math.floor(t.sourcePos.x+(t.targetPos.x-t.sourcePos.x)*c),l=Math.floor(t.sourcePos.y+(t.targetPos.y-t.sourcePos.y)*c)}l>=0&&l<e&&a>=0&&a<o&&(i[l][a]={char:n.charAt(0),color:t.color})}let s=`



`;for(let t=0;t<e;t++){s+="  ";for(let n=0;n<o;n++){const r=i[t][n];r.char!==" "&&r.color?s+=`<span class="${r.color}">${r.char}</span>`:s+=r.char}s+=`
`}return s}const Gs=document.getElementById("display"),pi=document.getElementById("play-btn"),gi=document.getElementById("pause-btn"),Qs=document.getElementById("step-btn"),Zs=document.getElementById("reset-btn"),en=document.getElementById("speed-down"),tn=document.getElementById("speed-up"),Pe=document.getElementById("speed-label"),Q=document.getElementById("seed-input"),fe=document.getElementById("class-select"),xe=document.getElementById("status-label"),mi=document.getElementById("biome-select"),sn=document.getElementById("weather-layer"),nn=document.getElementById("effects-layer"),pt=document.getElementById("skill-panel-header"),pe=document.getElementById("skill-list"),Re=document.getElementById("strategy-preset-select"),wt=document.getElementById("obj-clear-mobs"),Mt=document.getElementById("obj-kill-boss"),xt=document.getElementById("obj-find-treasure"),ge=document.getElementById("nav-exploration"),yi=document.getElementById("nav-exploration-val"),me=document.getElementById("nav-danger"),bi=document.getElementById("nav-danger-val"),ye=document.getElementById("nav-exit"),vi=document.getElementById("nav-exit-val"),It=document.getElementById("combat-target"),be=document.getElementById("combat-kite"),_i=document.getElementById("combat-kite-val"),ve=document.getElementById("combat-retreat"),ki=document.getElementById("combat-retreat-val");let L,dt,ht=null,ut=null,Ie=0,z=2,Fe=[];function je(){return fe.value||"ranger"}function on(){return mi.value||"rust_tides"}function an(o){document.body.classList.remove("biome-rust_tides","biome-glass_flood","biome-neon_decay"),document.body.classList.add(`biome-${o}`)}function rn(){const o=Re.value;return o!=="custom"&&he[o]?he[o]:{objectives:{clearAllMobs:wt.checked,killBoss:Mt.checked,findAllTreasure:xt.checked},engagement:{maxNormalMobs:5,maxEliteMobs:3,maxBosses:2,preferredPullSize:3},combat:{targetPriority:It.value,kiteEnabled:!0,kiteThreshold:parseInt(be.value)/100,retreatThreshold:parseInt(ve.value)/100,useAoE:!0,aoeThreshold:2},navigation:{preferUnexplored:parseInt(ge.value)/100,avoidDanger:parseInt(me.value)/100,exitPriority:parseInt(ye.value)/100}}}function ee(o,e,i){const s=je(),t=rn(),n={seed:o,mapWidth:120,mapHeight:40,roomCount:12,mobDensity:.8,playerClass:s,strategyProfile:t,enableKiting:!0,kiteThreshold:.4,kiteDistance:3,biome:on()};an(n.biome),Fe.length>0&&(n.skillRules=Fe),L=Es(n),dt=$s(L.map),ht!==null&&clearInterval(ht),ht=window.setInterval(()=>{Os(dt),sn.textContent=qs(dt)},100),ut!==null&&clearInterval(ut),Js(),Ie=0,ut=window.setInterval(()=>{const r=L.eventLog;for(;Ie<r.length;){const l=r[Ie];if(l.type==="attack"){const c=l.payload,d=L.entities.get(c.attackerId),h=L.entities.get(c.targetId);d&&h&&Xs(c.skillId,d.position,h.position)}Ie++}zs();const a=Ks(L.map.width,L.map.height);nn.innerHTML=a},66),Le()}function wi(o){const e=Ne[o];if(e){Fe=li(o),pe.innerHTML="";for(const i of e.skills){const s=ai[i];if(!s)continue;const t=Fe.find(p=>p.skillId===i),n=document.createElement("div");n.className=`skill-item ${t?.enabled?"":"disabled"}`,n.dataset.skillId=i;const r=document.createElement("input");r.type="checkbox",r.checked=t?.enabled??!0,r.id=`skill-${i}`,r.addEventListener("change",()=>{t&&(t.enabled=r.checked),n.classList.toggle("disabled",!r.checked)});const a=document.createElement("label");a.htmlFor=`skill-${i}`,a.innerHTML=`<strong>${s.name}</strong>`;const l=document.createElement("span");l.className="skill-damage",l.textContent=`${s.damage} dmg`;const c=document.createElement("span");c.className="skill-cooldown",c.textContent=`${(s.cooldown/10).toFixed(1)}s`;const d=document.createElement("span");d.className="skill-cooldown-timer",d.id=`cooldown-timer-${i}`,d.textContent="",d.style.color="#f80",d.style.fontWeight="bold",d.style.marginLeft="4px",d.style.minWidth="32px",d.style.display="inline-block";const h=document.createElement("select");h.innerHTML=`
            <option value="always">Always</option>
            <option value="aoe2">2+ Enemies</option>
            <option value="aoe3">3+ Enemies</option>
            <option value="aoe4">4+ Enemies</option>
            <option value="elite">vs Elite</option>
            <option value="boss">vs Boss</option>
            <option value="lowHp">Low HP (<50%)</option>
        `,t?.minEnemiesNearby===2?h.value="aoe2":t?.minEnemiesNearby===3?h.value="aoe3":t?.minEnemiesNearby===4?h.value="aoe4":t?.onlyVsElite?h.value="elite":t?.onlyVsBoss?h.value="boss":t?.selfHpBelow?h.value="lowHp":h.value="always",h.addEventListener("change",()=>{if(t)switch(delete t.minEnemiesNearby,delete t.onlyVsElite,delete t.onlyVsBoss,delete t.selfHpBelow,h.value){case"aoe2":t.minEnemiesNearby=2;break;case"aoe3":t.minEnemiesNearby=3;break;case"aoe4":t.minEnemiesNearby=4;break;case"elite":t.onlyVsElite=!0;break;case"boss":t.onlyVsBoss=!0;break;case"lowHp":t.selfHpBelow=.5;break}}),n.appendChild(r),n.appendChild(a),n.appendChild(l),n.appendChild(c),n.appendChild(d),n.appendChild(h),pe.appendChild(n)}}}pt.addEventListener("click",()=>{const o=pe.style.display==="none";pe.style.display=o?"flex":"none",pt.textContent=o?" Skills (click to collapse)":" Skills (click to expand)"});wi(je());pe.style.display="flex";pt.textContent=" Skills (click to collapse)";function ln(){const o=L?.entities.get("player");if(!o)return;const e=Ne[je()];if(e)for(const i of e.skills){const s=document.getElementById(`cooldown-timer-${i}`);if(!s)continue;const t=o.skillCooldowns.get(i)??0;if(t>0){const n=(t/10).toFixed(1);s.textContent=`${n}s`,s.style.color="#f80"}else s.textContent="",s.style.color="#4f4"}}function Le(){const o=Rs(L,te[z]);Gs.innerHTML=o,ln(),L.complete?(xe.textContent=L.outcome==="victory"?" VICTORY":" DEFEAT",xe.style.color=L.outcome==="victory"?"#0f0":"#f44"):(xe.textContent=`Tick ${L.tick}`,xe.style.color="#888")}const U=Fs(()=>{L.complete?U.pause():(L=kt(L),Le())},o=>{pi.disabled=o.status==="playing",gi.disabled=o.status!=="playing"});pi.addEventListener("click",()=>{L.complete&&ee(parseInt(Q.value)||Date.now()),U.play()});gi.addEventListener("click",()=>{U.pause()});Qs.addEventListener("click",()=>{L.complete||(L=kt(L),Le())});Zs.addEventListener("click",()=>{U.stop(),ee(parseInt(Q.value)||Date.now())});en.addEventListener("click",()=>{z=Math.max(0,z-1),U.setSpeed(te[z]),Pe.textContent=`${te[z]}x`});tn.addEventListener("click",()=>{z=Math.min(te.length-1,z+1),U.setSpeed(te[z]),Pe.textContent=`${te[z]}x`});const ti=document.getElementById("random-seed-btn");ti&&ti.addEventListener("click",()=>{const o=Date.now();Q.value=o.toString(),U.stop(),ee(o)});fe.addEventListener("change",()=>{U.stop(),wi(je()),ee(parseInt(Q.value)||Date.now())});function ie(o,e){e.textContent=`${o.value}%`}function Mi(o){wt.checked=o.objectives.clearAllMobs,Mt.checked=o.objectives.killBoss,xt.checked=o.objectives.findAllTreasure,ge.value=String(Math.round(o.navigation.preferUnexplored*100)),ie(ge,yi),me.value=String(Math.round(o.navigation.avoidDanger*100)),ie(me,bi),ye.value=String(Math.round(o.navigation.exitPriority*100)),ie(ye,vi),It.value=o.combat.targetPriority,be.value=String(Math.round(o.combat.kiteThreshold*100)),ie(be,_i),ve.value=String(Math.round(o.combat.retreatThreshold*100)),ie(ve,ki)}Re.addEventListener("change",()=>{const o=Re.value;o!=="custom"&&he[o]&&Mi(he[o])});function ne(){Re.value="custom"}ge.addEventListener("input",()=>{ie(ge,yi),ne()});me.addEventListener("input",()=>{ie(me,bi),ne()});ye.addEventListener("input",()=>{ie(ye,vi),ne()});be.addEventListener("input",()=>{ie(be,_i),ne()});ve.addEventListener("input",()=>{ie(ve,ki),ne()});It.addEventListener("change",ne);wt.addEventListener("change",ne);Mt.addEventListener("change",ne);xt.addEventListener("change",ne);Mi(he.balanced);document.addEventListener("keydown",o=>{if(!(o.target instanceof HTMLInputElement))switch(o.code){case"Space":o.preventDefault(),U.getState().status==="playing"?U.pause():(L.complete&&ee(parseInt(Q.value)||Date.now()),U.play());break;case"ArrowRight":o.preventDefault(),L.complete||(L=kt(L),Le());break;case"Minus":case"NumpadSubtract":z=Math.max(0,z-1),U.setSpeed(te[z]),Pe.textContent=`${te[z]}x`;break;case"Equal":case"NumpadAdd":z=Math.min(te.length-1,z+1),U.setSpeed(te[z]),Pe.textContent=`${te[z]}x`;break;case"KeyR":U.stop(),ee(parseInt(Q.value)||Date.now());break;case"KeyN":const e=Date.now();Q.value=e.toString(),U.stop(),ee(e);break;case"Digit1":case"Numpad1":fe.value="warrior",U.stop(),ee(parseInt(Q.value)||Date.now());break;case"Digit2":case"Numpad2":fe.value="ranger",U.stop(),ee(parseInt(Q.value)||Date.now());break;case"Digit3":case"Numpad3":fe.value="mage",U.stop(),ee(parseInt(Q.value)||Date.now());break}});const xi=parseInt(Q.value)||12345;Q.value=xi.toString();mi.addEventListener("change",()=>{const o=parseInt(Q.value)||Date.now();ee(o)});ee(xi);console.log("Map-Based Combat Simulation initialized");console.log("Controls:");console.log("  Space: Play/Pause");console.log("  Right Arrow: Step forward");console.log("  +/-: Adjust speed");console.log("  R: Reset");console.log("  N: New random seed");
